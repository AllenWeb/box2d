var b2Settings={};b2Settings.USHRT_MAX=65535;b2Settings.b2_pi=Math.PI;b2Settings.b2_massUnitsPerKilogram=1;b2Settings.b2_timeUnitsPerSecond=1;b2Settings.b2_lengthUnitsPerMeter=30;b2Settings.b2_maxManifoldPoints=2;b2Settings.b2_maxShapesPerBody=64;b2Settings.b2_maxPolyVertices=8;b2Settings.b2_maxProxies=1024;b2Settings.b2_maxPairs=8*b2Settings.b2_maxProxies;b2Settings.b2_linearSlop=0.0050*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_angularSlop=2/180*b2Settings.b2_pi;
b2Settings.b2_velocityThreshold=1*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_maxLinearCorrection=0.2*b2Settings.b2_lengthUnitsPerMeter;b2Settings.b2_maxAngularCorrection=8/180*b2Settings.b2_pi;b2Settings.b2_contactBaumgarte=0.2;b2Settings.b2_timeToSleep=0.5*b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_linearSleepTolerance=0.01*b2Settings.b2_lengthUnitsPerMeter/b2Settings.b2_timeUnitsPerSecond;b2Settings.b2_angularSleepTolerance=2/180/b2Settings.b2_timeUnitsPerSecond;
b2Settings.FLT_EPSILON=1.192092896E-7;b2Settings.b2Assert=function(a){if(!a)throw"Assert Failed!";};var b2Vec2=function(a,c){if(a===undefined)a=0;this.x=a;if(c===undefined)c=0;this.y=c};b2Vec2.prototype.SetZero=function(){this.y=this.x=0};b2Vec2.prototype.Set=function(a,c){this.x=a;this.y=c};b2Vec2.prototype.SetV=function(a){this.x=a.x;this.y=a.y};b2Vec2.prototype.Negative=function(){return new b2Vec2(-this.x,-this.y)};b2Vec2.prototype.Copy=function(){return new b2Vec2(this.x,this.y)};
b2Vec2.prototype.Add=function(a){this.x+=a.x;this.y+=a.y};b2Vec2.prototype.Subtract=function(a){this.x-=a.x;this.y-=a.y};b2Vec2.prototype.Multiply=function(a){this.x*=a;this.y*=a};b2Vec2.prototype.MulM=function(a){var c=this.x;this.x=a.col1.x*c+a.col2.x*this.y;this.y=a.col1.y*c+a.col2.y*this.y};b2Vec2.prototype.MulTM=function(a){var c=b2Math.b2Dot(this,a.col1);this.y=b2Math.b2Dot(this,a.col2);this.x=c};b2Vec2.prototype.CrossVF=function(a){var c=this.x;this.x=a*this.y;this.y=-a*c};
b2Vec2.prototype.CrossFV=function(a){var c=this.x;this.x=-a*this.y;this.y=a*c};b2Vec2.prototype.MinV=function(a){this.x=this.x<a.x?this.x:a.x;this.y=this.y<a.y?this.y:a.y};b2Vec2.prototype.MaxV=function(a){this.x=this.x>a.x?this.x:a.x;this.y=this.y>a.y?this.y:a.y};b2Vec2.prototype.Abs=function(){this.x=Math.abs(this.x);this.y=Math.abs(this.y)};b2Vec2.prototype.Length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)};
b2Vec2.prototype.Normalize=function(){var a=this.Length();if(a<Number.MIN_VALUE)return 0;var c=1/a;this.x*=c;this.y*=c;return a};b2Vec2.prototype.IsValid=function(){return b2Math.b2IsValid(this.x)&&b2Math.b2IsValid(this.y)};b2Vec2.Make=function(a,c){return new b2Vec2(a,c)};
var b2Mat22=function(a,c,b){if(a==null)a=0;this.col1=new b2Vec2;this.col2=new b2Vec2;if(c!=null&&b!=null){this.col1.SetV(c);this.col2.SetV(b)}else{c=Math.cos(a);a=Math.sin(a);this.col1.x=c;this.col2.x=-a;this.col1.y=a;this.col2.y=c}};b2Mat22.prototype.Set=function(a){var c=Math.cos(a);a=Math.sin(a);this.col1.x=c;this.col2.x=-a;this.col1.y=a;this.col2.y=c};b2Mat22.prototype.SetVV=function(a,c){this.col1.SetV(a);this.col2.SetV(c)};b2Mat22.prototype.Copy=function(){return new b2Mat22(0,this.col1,this.col2)};
b2Mat22.prototype.SetM=function(a){this.col1.SetV(a.col1);this.col2.SetV(a.col2)};b2Mat22.prototype.AddM=function(a){this.col1.x+=a.col1.x;this.col1.y+=a.col1.y;this.col2.x+=a.col2.x;this.col2.y+=a.col2.y};b2Mat22.prototype.SetIdentity=function(){this.col1.x=1;this.col2.x=0;this.col1.y=0;this.col2.y=1};b2Mat22.prototype.SetZero=function(){this.col1.x=0;this.col2.x=0;this.col1.y=0;this.col2.y=0};
b2Mat22.prototype.Invert=function(a){var c=this.col1.x,b=this.col2.x,d=this.col1.y,e=this.col2.y,f=c*e-b*d;f=1/f;a.col1.x=f*e;a.col2.x=-f*b;a.col1.y=-f*d;a.col2.y=f*c;return a};b2Mat22.prototype.Solve=function(a,c,b){var d=this.col1.x,e=this.col2.x,f=this.col1.y,g=this.col2.y,h=d*g-e*f;h=1/h;a.x=h*(g*c-e*b);a.y=h*(d*b-f*c);return a};b2Mat22.prototype.Abs=function(){this.col1.Abs();this.col2.Abs()};var b2Math={};b2Math.b2IsValid=function(a){return isFinite(a)};
b2Math.b2Dot=function(a,c){return a.x*c.x+a.y*c.y};b2Math.b2CrossVV=function(a,c){return a.x*c.y-a.y*c.x};b2Math.b2CrossVF=function(a,c){return new b2Vec2(c*a.y,-c*a.x)};b2Math.b2CrossFV=function(a,c){return new b2Vec2(-a*c.y,a*c.x)};b2Math.b2MulMV=function(a,c){return new b2Vec2(a.col1.x*c.x+a.col2.x*c.y,a.col1.y*c.x+a.col2.y*c.y)};b2Math.b2MulTMV=function(a,c){return new b2Vec2(b2Math.b2Dot(c,a.col1),b2Math.b2Dot(c,a.col2))};b2Math.AddVV=function(a,c){return new b2Vec2(a.x+c.x,a.y+c.y)};
b2Math.SubtractVV=function(a,c){return new b2Vec2(a.x-c.x,a.y-c.y)};b2Math.MulFV=function(a,c){return new b2Vec2(a*c.x,a*c.y)};b2Math.AddMM=function(a,c){return new b2Mat22(0,b2Math.AddVV(a.col1,c.col1),b2Math.AddVV(a.col2,c.col2))};b2Math.b2MulMM=function(a,c){return new b2Mat22(0,b2Math.b2MulMV(a,c.col1),b2Math.b2MulMV(a,c.col2))};
b2Math.b2MulTMM=function(a,c){var b=new b2Vec2(b2Math.b2Dot(a.col1,c.col1),b2Math.b2Dot(a.col2,c.col1)),d=new b2Vec2(b2Math.b2Dot(a.col1,c.col2),b2Math.b2Dot(a.col2,c.col2));return new b2Mat22(0,b,d)};b2Math.b2Abs=function(a){return a>0?a:-a};b2Math.b2AbsV=function(a){return new b2Vec2(b2Math.b2Abs(a.x),b2Math.b2Abs(a.y))};b2Math.b2AbsM=function(a){return new b2Mat22(0,b2Math.b2AbsV(a.col1),b2Math.b2AbsV(a.col2))};b2Math.b2Min=function(a,c){return a<c?a:c};
b2Math.b2MinV=function(a,c){return new b2Vec2(b2Math.b2Min(a.x,c.x),b2Math.b2Min(a.y,c.y))};b2Math.b2Max=function(a,c){return a>c?a:c};b2Math.b2MaxV=function(a,c){return new b2Vec2(b2Math.b2Max(a.x,c.x),b2Math.b2Max(a.y,c.y))};b2Math.b2Clamp=function(a,c,b){return b2Math.b2Max(c,b2Math.b2Min(a,b))};b2Math.b2ClampV=function(a,c,b){return b2Math.b2MaxV(c,b2Math.b2MinV(a,b))};b2Math.b2Swap=function(a,c){var b=a[0];a[0]=c[0];c[0]=b};b2Math.b2Random=function(){return Math.random()*2-1};
b2Math.b2NextPowerOfTwo=function(a){a|=a>>1&2147483647;a|=a>>2&1073741823;a|=a>>4&268435455;a|=a>>8&16777215;a|=a>>16&65535;return a+1};b2Math.b2IsPowerOfTwo=function(a){return a>0&&(a&a-1)==0};var b2AABB=function(){this.minVertex=new b2Vec2;this.maxVertex=new b2Vec2};b2AABB.prototype.IsValid=function(){var a=this.maxVertex.x,c=this.maxVertex.y;a=this.maxVertex.x;c=this.maxVertex.y;a-=this.minVertex.x;c-=this.minVertex.y;return a=(a=a>=0&&c>=0)&&this.minVertex.IsValid()&&this.maxVertex.IsValid()};
var b2Bound=function(){};b2Bound.prototype={IsLower:function(){return(this.value&1)==0},IsUpper:function(){return(this.value&1)==1},Swap:function(a){var c=this.value,b=this.proxyId,d=this.stabbingCount;this.value=a.value;this.proxyId=a.proxyId;this.stabbingCount=a.stabbingCount;a.value=c;a.proxyId=b;a.stabbingCount=d},value:0,proxyId:0,stabbingCount:0};var b2BoundValues=function(){this.lowerValues=[0,0];this.upperValues=[0,0]},b2Pair=function(){};
b2Pair.prototype={SetBuffered:function(){this.status|=b2Pair.e_pairBuffered},ClearBuffered:function(){this.status&=~b2Pair.e_pairBuffered},IsBuffered:function(){return(this.status&b2Pair.e_pairBuffered)==b2Pair.e_pairBuffered},SetRemoved:function(){this.status|=b2Pair.e_pairRemoved},ClearRemoved:function(){this.status&=~b2Pair.e_pairRemoved},IsRemoved:function(){return(this.status&b2Pair.e_pairRemoved)==b2Pair.e_pairRemoved},SetFinal:function(){this.status|=b2Pair.e_pairFinal},IsFinal:function(){return(this.status&
b2Pair.e_pairFinal)==b2Pair.e_pairFinal},userData:null,proxyId1:0,proxyId2:0,next:0,status:0};b2Pair.b2_nullPair=b2Settings.USHRT_MAX;b2Pair.b2_nullProxy=b2Settings.USHRT_MAX;b2Pair.b2_tableCapacity=b2Settings.b2_maxPairs;b2Pair.b2_tableMask=b2Pair.b2_tableCapacity-1;b2Pair.e_pairBuffered=1;b2Pair.e_pairRemoved=2;b2Pair.e_pairFinal=4;var b2PairCallback=function(){};b2PairCallback.prototype={PairAdded:function(){return null},PairRemoved:function(){}};var b2BufferedPair=function(){};
b2BufferedPair.prototype={proxyId1:0,proxyId2:0};var b2PairManager=Class.create();
b2PairManager.prototype={initialize:function(){var a=0;this.m_hashTable=Array(b2Pair.b2_tableCapacity);for(a=0;a<b2Pair.b2_tableCapacity;++a)this.m_hashTable[a]=b2Pair.b2_nullPair;this.m_pairs=Array(b2Settings.b2_maxPairs);for(a=0;a<b2Settings.b2_maxPairs;++a)this.m_pairs[a]=new b2Pair;this.m_pairBuffer=Array(b2Settings.b2_maxPairs);for(a=0;a<b2Settings.b2_maxPairs;++a)this.m_pairBuffer[a]=new b2BufferedPair;for(a=0;a<b2Settings.b2_maxPairs;++a){this.m_pairs[a].proxyId1=b2Pair.b2_nullProxy;this.m_pairs[a].proxyId2=
b2Pair.b2_nullProxy;this.m_pairs[a].userData=null;this.m_pairs[a].status=0;this.m_pairs[a].next=a+1}this.m_pairs[b2Settings.b2_maxPairs-1].next=b2Pair.b2_nullPair;this.m_pairCount=0},Initialize:function(a,c){this.m_broadPhase=a;this.m_callback=c},AddBufferedPair:function(a,c){var b=this.AddPair(a,c);if(b.IsBuffered()==false){b.SetBuffered();this.m_pairBuffer[this.m_pairBufferCount].proxyId1=b.proxyId1;this.m_pairBuffer[this.m_pairBufferCount].proxyId2=b.proxyId2;++this.m_pairBufferCount}b.ClearRemoved();
b2BroadPhase.s_validate&&this.ValidateBuffer()},RemoveBufferedPair:function(a,c){var b=this.Find(a,c);if(b!=null){if(b.IsBuffered()==false){b.SetBuffered();this.m_pairBuffer[this.m_pairBufferCount].proxyId1=b.proxyId1;this.m_pairBuffer[this.m_pairBufferCount].proxyId2=b.proxyId2;++this.m_pairBufferCount}b.SetRemoved();b2BroadPhase.s_validate&&this.ValidateBuffer()}},Commit:function(){var a=0,c=0,b=this.m_broadPhase.m_proxyPool;for(a=0;a<this.m_pairBufferCount;++a){var d=this.Find(this.m_pairBuffer[a].proxyId1,
this.m_pairBuffer[a].proxyId2);d.ClearBuffered();var e=b[d.proxyId1],f=b[d.proxyId2];if(d.IsRemoved()){d.IsFinal()==true&&this.m_callback.PairRemoved(e.userData,f.userData,d.userData);this.m_pairBuffer[c].proxyId1=d.proxyId1;this.m_pairBuffer[c].proxyId2=d.proxyId2;++c}else if(d.IsFinal()==false){d.userData=this.m_callback.PairAdded(e.userData,f.userData);d.SetFinal()}}for(a=0;a<c;++a)this.RemovePair(this.m_pairBuffer[a].proxyId1,this.m_pairBuffer[a].proxyId2);this.m_pairBufferCount=0;b2BroadPhase.s_validate&&
this.ValidateTable()},AddPair:function(a,c){if(a>c){var b=a;a=c;c=b}b=b2PairManager.Hash(a,c)&b2Pair.b2_tableMask;var d=d=this.FindHash(a,c,b);if(d!=null)return d;var e=this.m_freePair;d=this.m_pairs[e];this.m_freePair=d.next;d.proxyId1=a;d.proxyId2=c;d.status=0;d.userData=null;d.next=this.m_hashTable[b];this.m_hashTable[b]=e;++this.m_pairCount;return d},RemovePair:function(a,c){if(a>c){var b=a;a=c;c=b}for(var d=b2PairManager.Hash(a,c)&b2Pair.b2_tableMask,e=this.m_hashTable[d],f=null;e!=b2Pair.b2_nullPair;)if(b2PairManager.Equals(this.m_pairs[e],
a,c)){b=e;if(f)f.next=this.m_pairs[e].next;else this.m_hashTable[d]=this.m_pairs[e].next;d=this.m_pairs[b];e=d.userData;d.next=this.m_freePair;d.proxyId1=b2Pair.b2_nullProxy;d.proxyId2=b2Pair.b2_nullProxy;d.userData=null;d.status=0;this.m_freePair=b;--this.m_pairCount;return e}else{f=this.m_pairs[e];e=f.next}return null},Find:function(a,c){if(a>c){var b=a;a=c;c=b}b=b2PairManager.Hash(a,c)&b2Pair.b2_tableMask;return this.FindHash(a,c,b)},FindHash:function(a,c,b){for(b=this.m_hashTable[b];b!=b2Pair.b2_nullPair&&
b2PairManager.Equals(this.m_pairs[b],a,c)==false;)b=this.m_pairs[b].next;if(b==b2Pair.b2_nullPair)return null;return this.m_pairs[b]},ValidateBuffer:function(){},ValidateTable:function(){},m_broadPhase:null,m_callback:null,m_pairs:null,m_freePair:0,m_pairCount:0,m_pairBuffer:null,m_pairBufferCount:0,m_hashTable:null};b2PairManager.Hash=function(a,c){var b=c<<16&4294901760|a;b=~b+(b<<15&4294934528);b^=b>>12&1048575;b+=b<<2&4294967292;b^=b>>4&268435455;b*=2057;b^=b>>16&65535;return b};
b2PairManager.Equals=function(a,c,b){return a.proxyId1==c&&a.proxyId2==b};b2PairManager.EqualsPair=function(a,c){return a.proxyId1==c.proxyId1&&a.proxyId2==c.proxyId2};var b2BroadPhase=Class.create();
b2BroadPhase.prototype={initialize:function(a,c){this.m_pairManager=new b2PairManager;this.m_proxyPool=Array(b2Settings.b2_maxPairs);this.m_bounds=Array(2*b2Settings.b2_maxProxies);this.m_queryResults=Array(b2Settings.b2_maxProxies);this.m_quantizationFactor=new b2Vec2;var b=0;this.m_pairManager.Initialize(this,c);this.m_worldAABB=a;for(b=this.m_proxyCount=0;b<b2Settings.b2_maxProxies;b++)this.m_queryResults[b]=0;this.m_bounds=Array(2);for(b=0;b<2;b++){this.m_bounds[b]=Array(2*b2Settings.b2_maxProxies);
for(var d=0;d<2*b2Settings.b2_maxProxies;d++)this.m_bounds[b][d]=new b2Bound}b=a.maxVertex.x;d=a.maxVertex.y;b-=a.minVertex.x;d-=a.minVertex.y;this.m_quantizationFactor.x=b2Settings.USHRT_MAX/b;this.m_quantizationFactor.y=b2Settings.USHRT_MAX/d;for(b=0;b<b2Settings.b2_maxProxies-1;++b){d=new b2Proxy;this.m_proxyPool[b]=d;d.SetNext(b+1);d.timeStamp=0;d.overlapCount=b2BroadPhase.b2_invalid;d.userData=null}d=new b2Proxy;this.m_proxyPool[b2Settings.b2_maxProxies-1]=d;d.SetNext(b2Pair.b2_nullProxy);d.timeStamp=
0;d.overlapCount=b2BroadPhase.b2_invalid;d.userData=null;this.m_freeProxy=0;this.m_timeStamp=1;this.m_queryResultCount=0},InRange:function(a){var c,b,d,e;c=a.minVertex.x;b=a.minVertex.y;c-=this.m_worldAABB.maxVertex.x;b-=this.m_worldAABB.maxVertex.y;d=this.m_worldAABB.minVertex.x;e=this.m_worldAABB.minVertex.y;d-=a.maxVertex.x;e-=a.maxVertex.y;c=b2Math.b2Max(c,d);b=b2Math.b2Max(b,e);return b2Math.b2Max(c,b)<0},GetProxy:function(a){if(a==b2Pair.b2_nullProxy||this.m_proxyPool[a].IsValid()==false)return null;
return this.m_proxyPool[a]},CreateProxy:function(a,c){var b=0,d,e=this.m_freeProxy;d=this.m_proxyPool[e];this.m_freeProxy=d.GetNext();d.overlapCount=0;d.userData=c;d=2*this.m_proxyCount;var f=[],g=[];this.ComputeBounds(f,g,a);for(var h=0;h<2;++h){var i=this.m_bounds[h],j=0,k=0;j=[j];k=[k];this.Query(j,k,f[h],g[h],i,d,h);j=j[0];k=k[0];b=[];var l=0,m=d-k,n,o;for(l=0;l<m;l++){b[l]=new b2Bound;n=b[l];o=i[k+l];n.value=o.value;n.proxyId=o.proxyId;n.stabbingCount=o.stabbingCount}m=b.length;var q=k+2;for(l=
0;l<m;l++){o=b[l];n=i[q+l];n.value=o.value;n.proxyId=o.proxyId;n.stabbingCount=o.stabbingCount}b=[];m=k-j;for(l=0;l<m;l++){b[l]=new b2Bound;n=b[l];o=i[j+l];n.value=o.value;n.proxyId=o.proxyId;n.stabbingCount=o.stabbingCount}m=b.length;q=j+1;for(l=0;l<m;l++){o=b[l];n=i[q+l];n.value=o.value;n.proxyId=o.proxyId;n.stabbingCount=o.stabbingCount}++k;i[j].value=f[h];i[j].proxyId=e;i[k].value=g[h];i[k].proxyId=e;i[j].stabbingCount=j==0?0:i[j-1].stabbingCount;i[k].stabbingCount=i[k-1].stabbingCount;for(b=
j;b<k;++b)i[b].stabbingCount++;for(b=j;b<d+2;++b){j=this.m_proxyPool[i[b].proxyId];if(i[b].IsLower())j.lowerBounds[h]=b;else j.upperBounds[h]=b}}++this.m_proxyCount;for(d=0;d<this.m_queryResultCount;++d)this.m_pairManager.AddBufferedPair(e,this.m_queryResults[d]);this.m_pairManager.Commit();this.m_queryResultCount=0;this.IncrementTimeStamp();return e},DestroyProxy:function(a){for(var c=this.m_proxyPool[a],b=2*this.m_proxyCount,d=0;d<2;++d){var e=this.m_bounds[d],f=c.lowerBounds[d],g=c.upperBounds[d],
h=e[f].value,i=e[g].value,j=[],k=0,l=g-f-1,m,n;for(k=0;k<l;k++){j[k]=new b2Bound;m=j[k];n=e[f+1+k];m.value=n.value;m.proxyId=n.proxyId;m.stabbingCount=n.stabbingCount}l=j.length;var o=f;for(k=0;k<l;k++){n=j[k];m=e[o+k];m.value=n.value;m.proxyId=n.proxyId;m.stabbingCount=n.stabbingCount}j=[];l=b-g-1;for(k=0;k<l;k++){j[k]=new b2Bound;m=j[k];n=e[g+1+k];m.value=n.value;m.proxyId=n.proxyId;m.stabbingCount=n.stabbingCount}l=j.length;o=g-1;for(k=0;k<l;k++){n=j[k];m=e[o+k];m.value=n.value;m.proxyId=n.proxyId;
m.stabbingCount=n.stabbingCount}l=b-2;for(j=f;j<l;++j){k=this.m_proxyPool[e[j].proxyId];if(e[j].IsLower())k.lowerBounds[d]=j;else k.upperBounds[d]=j}l=g-1;for(f=f;f<l;++f)e[f].stabbingCount--;this.Query([0],[0],h,i,e,b-2,d)}for(b=0;b<this.m_queryResultCount;++b)this.m_pairManager.RemoveBufferedPair(a,this.m_queryResults[b]);this.m_pairManager.Commit();this.m_queryResultCount=0;this.IncrementTimeStamp();c.userData=null;c.overlapCount=b2BroadPhase.b2_invalid;c.lowerBounds[0]=b2BroadPhase.b2_invalid;
c.lowerBounds[1]=b2BroadPhase.b2_invalid;c.upperBounds[0]=b2BroadPhase.b2_invalid;c.upperBounds[1]=b2BroadPhase.b2_invalid;c.SetNext(this.m_freeProxy);this.m_freeProxy=a;--this.m_proxyCount},MoveProxy:function(a,c){var b=0,d=0,e,f,g=0,h;if(!(a==b2Pair.b2_nullProxy||b2Settings.b2_maxProxies<=a))if(c.IsValid()!=false){var i=2*this.m_proxyCount,j=this.m_proxyPool[a],k=new b2BoundValues;this.ComputeBounds(k.lowerValues,k.upperValues,c);var l=new b2BoundValues;for(b=0;b<2;++b){l.lowerValues[b]=this.m_bounds[b][j.lowerBounds[b]].value;
l.upperValues[b]=this.m_bounds[b][j.upperBounds[b]].value}for(b=0;b<2;++b){var m=this.m_bounds[b],n=j.lowerBounds[b],o=j.upperBounds[b],q=k.lowerValues[b],r=k.upperValues[b],p=q-m[n].value,s=r-m[o].value;m[n].value=q;m[o].value=r;if(p<0)for(d=n;d>0&&q<m[d-1].value;){e=m[d];f=m[d-1];g=f.proxyId;h=this.m_proxyPool[f.proxyId];f.stabbingCount++;if(f.IsUpper()==true){this.TestOverlap(k,h)&&this.m_pairManager.AddBufferedPair(a,g);h.upperBounds[b]++;e.stabbingCount++}else{h.lowerBounds[b]++;e.stabbingCount--}j.lowerBounds[b]--;
e.Swap(f);--d}if(s>0)for(d=o;d<i-1&&m[d+1].value<=r;){e=m[d];f=m[d+1];g=f.proxyId;h=this.m_proxyPool[g];f.stabbingCount++;if(f.IsLower()==true){this.TestOverlap(k,h)&&this.m_pairManager.AddBufferedPair(a,g);h.lowerBounds[b]--;e.stabbingCount++}else{h.upperBounds[b]--;e.stabbingCount--}j.upperBounds[b]++;e.Swap(f);d++}if(p>0)for(d=n;d<i-1&&m[d+1].value<=q;){e=m[d];f=m[d+1];g=f.proxyId;h=this.m_proxyPool[g];f.stabbingCount--;if(f.IsUpper()){this.TestOverlap(l,h)&&this.m_pairManager.RemoveBufferedPair(a,
g);h.upperBounds[b]--;e.stabbingCount--}else{h.lowerBounds[b]--;e.stabbingCount++}j.lowerBounds[b]++;e.Swap(f);d++}if(s<0)for(d=o;d>0&&r<m[d-1].value;){e=m[d];f=m[d-1];g=f.proxyId;h=this.m_proxyPool[g];f.stabbingCount--;if(f.IsLower()==true){this.TestOverlap(l,h)&&this.m_pairManager.RemoveBufferedPair(a,g);h.lowerBounds[b]++;e.stabbingCount--}else{h.upperBounds[b]++;e.stabbingCount++}j.upperBounds[b]--;e.Swap(f);d--}}}},Commit:function(){this.m_pairManager.Commit()},QueryAABB:function(a,c,b){var d=
[],e=[];this.ComputeBounds(d,e,a);a=[0];var f=[0];this.Query(a,f,d[0],e[0],this.m_bounds[0],2*this.m_proxyCount,0);this.Query(a,f,d[1],e[1],this.m_bounds[1],2*this.m_proxyCount,1);for(e=d=0;e<this.m_queryResultCount&&d<b;++e,++d)c[e]=this.m_proxyPool[this.m_queryResults[e]].userData;this.m_queryResultCount=0;this.IncrementTimeStamp();return d},Validate:function(){for(var a=0;a<2;++a)for(var c=this.m_bounds[a],b=2*this.m_proxyCount,d=0,e=0;e<b;++e)if(c[e].IsLower()==true)d++;else d--},ComputeBounds:function(a,
c,b){var d=b.minVertex.x,e=b.minVertex.y;d=b2Math.b2Min(d,this.m_worldAABB.maxVertex.x);e=b2Math.b2Min(e,this.m_worldAABB.maxVertex.y);d=b2Math.b2Max(d,this.m_worldAABB.minVertex.x);e=b2Math.b2Max(e,this.m_worldAABB.minVertex.y);var f=b.maxVertex.x;b=b.maxVertex.y;f=b2Math.b2Min(f,this.m_worldAABB.maxVertex.x);b=b2Math.b2Min(b,this.m_worldAABB.maxVertex.y);f=b2Math.b2Max(f,this.m_worldAABB.minVertex.x);b=b2Math.b2Max(b,this.m_worldAABB.minVertex.y);a[0]=this.m_quantizationFactor.x*(d-this.m_worldAABB.minVertex.x)&
b2Settings.USHRT_MAX-1;c[0]=this.m_quantizationFactor.x*(f-this.m_worldAABB.minVertex.x)&65535|1;a[1]=this.m_quantizationFactor.y*(e-this.m_worldAABB.minVertex.y)&b2Settings.USHRT_MAX-1;c[1]=this.m_quantizationFactor.y*(b-this.m_worldAABB.minVertex.y)&65535|1},TestOverlapValidate:function(a,c){for(var b=0;b<2;++b){var d=this.m_bounds[b];if(d[a.lowerBounds[b]].value>d[c.upperBounds[b]].value)return false;if(d[a.upperBounds[b]].value<d[c.lowerBounds[b]].value)return false}return true},TestOverlap:function(a,
c){for(var b=0;b<2;++b){var d=this.m_bounds[b];if(a.lowerValues[b]>d[c.upperBounds[b]].value)return false;if(a.upperValues[b]<d[c.lowerBounds[b]].value)return false}return true},Query:function(a,c,b,d,e,f,g){b=b2BroadPhase.BinarySearch(e,f,b);d=b2BroadPhase.BinarySearch(e,f,d);for(f=b;f<d;++f)e[f].IsLower()&&this.IncrementOverlapCount(e[f].proxyId);if(b>0){f=b-1;for(var h=e[f].stabbingCount;h;){if(e[f].IsLower())if(b<=this.m_proxyPool[e[f].proxyId].upperBounds[g]){this.IncrementOverlapCount(e[f].proxyId);
--h}--f}}a[0]=b;c[0]=d},IncrementOverlapCount:function(a){var c=this.m_proxyPool[a];if(c.timeStamp<this.m_timeStamp){c.timeStamp=this.m_timeStamp;c.overlapCount=1}else{c.overlapCount=2;this.m_queryResults[this.m_queryResultCount]=a;++this.m_queryResultCount}},IncrementTimeStamp:function(){if(this.m_timeStamp==b2Settings.USHRT_MAX){for(var a=0;a<b2Settings.b2_maxProxies;++a)this.m_proxyPool[a].timeStamp=0;this.m_timeStamp=1}else++this.m_timeStamp},m_pairManager:new b2PairManager,m_proxyPool:Array(b2Settings.b2_maxPairs),
m_freeProxy:0,m_bounds:Array(2*b2Settings.b2_maxProxies),m_queryResults:Array(b2Settings.b2_maxProxies),m_queryResultCount:0,m_worldAABB:null,m_quantizationFactor:new b2Vec2,m_proxyCount:0,m_timeStamp:0};b2BroadPhase.s_validate=false;b2BroadPhase.b2_invalid=b2Settings.USHRT_MAX;b2BroadPhase.b2_nullEdge=b2Settings.USHRT_MAX;b2BroadPhase.BinarySearch=function(a,c,b){var d=0;for(c=c-1;d<=c;){var e=Math.floor((d+c)/2);if(a[e].value>b)c=e-1;else if(a[e].value<b)d=e+1;else return e}return d};
var b2Collision={};b2Collision.b2_nullFeature=255;b2Collision.ClipSegmentToLine=function(a,c,b,d){var e=0,f=c[0].v,g=c[1].v,h=b2Math.b2Dot(b,c[0].v)-d;b=b2Math.b2Dot(b,c[1].v)-d;if(h<=0)a[e++]=c[0];if(b<=0)a[e++]=c[1];if(h*b<0){b=h/(h-b);d=a[e].v;d.x=f.x+b*(g.x-f.x);d.y=f.y+b*(g.y-f.y);a[e].id=h>0?c[0].id:c[1].id;++e}return e};
b2Collision.EdgeSeparation=function(a,c,b){var d=a.m_vertices,e=b.m_vertexCount,f=b.m_vertices,g=a.m_normals[c].x,h=a.m_normals[c].y,i=g,j=a.m_R;g=j.col1.x*i+j.col2.x*h;h=j.col1.y*i+j.col2.y*h;var k=g,l=h;j=b.m_R;i=k*j.col1.x+l*j.col1.y;l=k*j.col2.x+l*j.col2.y;k=i;i=0;j=Number.MAX_VALUE;for(var m=0;m<e;++m){var n=f[m];n=n.x*k+n.y*l;if(n<j){j=n;i=m}}j=a.m_R;e=a.m_position.x+(j.col1.x*d[c].x+j.col2.x*d[c].y);a=a.m_position.y+(j.col1.y*d[c].x+j.col2.y*d[c].y);j=b.m_R;c=b.m_position.x+(j.col1.x*f[i].x+
j.col2.x*f[i].y);b=b.m_position.y+(j.col1.y*f[i].x+j.col2.y*f[i].y);c-=e;b-=a;return c*g+b*h};
b2Collision.FindMaxSeparation=function(a,c,b,d){var e=c.m_vertexCount,f=b.m_position.x-c.m_position.x,g=b.m_position.y-c.m_position.y,h=f*c.m_R.col1.x+g*c.m_R.col1.y;g=f*c.m_R.col2.x+g*c.m_R.col2.y;f=0;for(var i=-Number.MAX_VALUE,j=0;j<e;++j){var k=c.m_normals[j].x*h+c.m_normals[j].y*g;if(k>i){i=k;f=j}}h=b2Collision.EdgeSeparation(c,f,b);if(h>0&&d==false)return h;j=f-1>=0?f-1:e-1;k=b2Collision.EdgeSeparation(c,j,b);if(k>0&&d==false)return k;var l=f+1<e?f+1:0,m=b2Collision.EdgeSeparation(c,l,b);if(m>
0&&d==false)return m;i=g=0;if(k>h&&k>m){i=-1;g=j;j=k}else if(m>h){i=1;g=l;j=m}else{a[0]=f;return h}for(;;){f=i==-1?g-1>=0?g-1:e-1:g+1<e?g+1:0;h=b2Collision.EdgeSeparation(c,f,b);if(h>0&&d==false)return h;if(h>j){g=f;j=h}else break}a[0]=g;return j};
b2Collision.FindIncidentEdge=function(a,c,b,d){var e=c.m_vertices,f=d.m_vertexCount,g=d.m_vertices,h=e[b+1==c.m_vertexCount?0:b+1],i=h.x,j=h.y;h=e[b];i-=h.x;j-=h.y;h=i;i=j;j=-h;h=1/Math.sqrt(i*i+j*j);i*=h;j*=h;i=i;j=j;h=i;e=c.m_R;i=e.col1.x*h+e.col2.x*j;j=e.col1.y*h+e.col2.y*j;c=i;j=j;e=d.m_R;h=c*e.col1.x+j*e.col1.y;j=c*e.col2.x+j*e.col2.y;c=h;e=i=0;for(var k=Number.MAX_VALUE,l=0;l<f;++l){var m=l,n=l+1<f?l+1:0;h=g[n];var o=h.x,q=h.y;h=g[m];o-=h.x;q-=h.y;h=o;o=q;q=-h;h=1/Math.sqrt(o*o+q*q);o*=h;q*=
h;h=o*c+q*j;if(h<k){k=h;i=m;e=n}}f=a[0];h=f.v;h.SetV(g[i]);h.MulM(d.m_R);h.Add(d.m_position);f.id.features.referenceFace=b;f.id.features.incidentEdge=i;f.id.features.incidentVertex=i;f=a[1];h=f.v;h.SetV(g[e]);h.MulM(d.m_R);h.Add(d.m_position);f.id.features.referenceFace=b;f.id.features.incidentEdge=i;f.id.features.incidentVertex=e};b2Collision.b2CollidePolyTempVec=new b2Vec2;
b2Collision.b2CollidePoly=function(a,c,b,d){var e=a.pointCount=0,f=[e],g=b2Collision.FindMaxSeparation(f,c,b,d);e=f[0];if(!(g>0&&d==false)){var h=0;f=[h];var i=b2Collision.FindMaxSeparation(f,b,c,d);h=f[0];if(!(i>0&&d==false)){var j=0;f=0;if(i>0.98*g+0.0010){g=b;c=c;j=h;f=1}else{g=c;c=b;j=e;f=0}b=[new ClipVertex,new ClipVertex];b2Collision.FindIncidentEdge(b,g,j,c);c=g.m_vertices;var k=c[j],l=j+1<g.m_vertexCount?c[j+1]:c[0];e=l.x-k.x;h=l.y-k.y;var m=e,n=g.m_R;e=n.col1.x*m+n.col2.x*h;h=n.col1.y*m+
n.col2.y*h;j=1/Math.sqrt(e*e+h*h);e*=j;h*=j;j=e;c=h;m=j;j=c;c=-m;i=k.x;var o=k.y;m=i;n=g.m_R;i=n.col1.x*m+n.col2.x*o;o=n.col1.y*m+n.col2.y*o;i+=g.m_position.x;o+=g.m_position.y;k=l.x;l=l.y;m=k;n=g.m_R;k=n.col1.x*m+n.col2.x*l;l=n.col1.y*m+n.col2.y*l;k+=g.m_position.x;l+=g.m_position.y;g=j*i+c*o;m=-(e*i+h*o);k=e*k+h*l;l=[new ClipVertex,new ClipVertex];i=[new ClipVertex,new ClipVertex];n=0;b2Collision.b2CollidePolyTempVec.Set(-e,-h);n=b2Collision.ClipSegmentToLine(l,b,b2Collision.b2CollidePolyTempVec,
m);if(!(n<2)){b2Collision.b2CollidePolyTempVec.Set(e,h);n=b2Collision.ClipSegmentToLine(i,l,b2Collision.b2CollidePolyTempVec,k);if(!(n<2)){f?a.normal.Set(-j,-c):a.normal.Set(j,c);for(e=b=0;e<b2Settings.b2_maxManifoldPoints;++e){h=i[e].v;h=j*h.x+c*h.y-g;if(h<=0||d==true){k=a.points[b];k.separation=h;k.position.SetV(i[e].v);k.id.Set(i[e].id);k.id.features.flip=f;++b}}a.pointCount=b}}}}};
b2Collision.b2CollideCircle=function(a,c,b,d){a.pointCount=0;var e=b.m_position.x-c.m_position.x,f=b.m_position.y-c.m_position.y,g=e*e+f*f;c=c.m_radius+b.m_radius;if(!(g>c*c&&d==false)){if(g<Number.MIN_VALUE){d=-c;a.normal.Set(0,1)}else{g=Math.sqrt(g);d=g-c;g=1/g;a.normal.x=g*e;a.normal.y=g*f}a.pointCount=1;e=a.points[0];e.id.set_key(0);e.separation=d;e.position.x=b.m_position.x-b.m_radius*a.normal.x;e.position.y=b.m_position.y-b.m_radius*a.normal.y}};
b2Collision.b2CollidePolyAndCircle=function(a,c,b){a.pointCount=0;var d,e,f;e=b.m_position.x-c.m_position.x;f=b.m_position.y-c.m_position.y;var g=c.m_R,h=e*g.col1.x+f*g.col1.y;f=e*g.col2.x+f*g.col2.y;e=h;var i=0,j=-Number.MAX_VALUE;h=b.m_radius;for(d=0;d<c.m_vertexCount;++d){var k=c.m_normals[d].x*(e-c.m_vertices[d].x)+c.m_normals[d].y*(f-c.m_vertices[d].y);if(k>h)return;if(k>j){j=k;i=d}}if(j<Number.MIN_VALUE){a.pointCount=1;f=c.m_normals[i];a.normal.x=g.col1.x*f.x+g.col2.x*f.y;a.normal.y=g.col1.y*
f.x+g.col2.y*f.y;d=a.points[0];d.id.features.incidentEdge=i;d.id.features.incidentVertex=b2Collision.b2_nullFeature;d.id.features.referenceFace=b2Collision.b2_nullFeature;d.id.features.flip=0;d.position.x=b.m_position.x-h*a.normal.x;d.position.y=b.m_position.y-h*a.normal.y;d.separation=j-h}else{i=i;j=i+1<c.m_vertexCount?i+1:0;var l=c.m_vertices[j].x-c.m_vertices[i].x;k=c.m_vertices[j].y-c.m_vertices[i].y;var m=Math.sqrt(l*l+k*k);l/=m;k/=m;if(m<Number.MIN_VALUE){e=e-c.m_vertices[i].x;f=f-c.m_vertices[i].y;
c=Math.sqrt(e*e+f*f);e/=c;f/=c;if(!(c>h)){a.pointCount=1;a.normal.Set(g.col1.x*e+g.col2.x*f,g.col1.y*e+g.col2.y*f);d=a.points[0];d.id.features.incidentEdge=b2Collision.b2_nullFeature;d.id.features.incidentVertex=i;d.id.features.referenceFace=b2Collision.b2_nullFeature;d.id.features.flip=0;d.position.x=b.m_position.x-h*a.normal.x;d.position.y=b.m_position.y-h*a.normal.y;d.separation=c-h}}else{var n=(e-c.m_vertices[i].x)*l+(f-c.m_vertices[i].y)*k;d=a.points[0];d.id.features.incidentEdge=b2Collision.b2_nullFeature;
d.id.features.incidentVertex=b2Collision.b2_nullFeature;d.id.features.referenceFace=b2Collision.b2_nullFeature;d.id.features.flip=0;if(n<=0){l=c.m_vertices[i].x;c=c.m_vertices[i].y;d.id.features.incidentVertex=i}else if(n>=m){l=c.m_vertices[j].x;c=c.m_vertices[j].y;d.id.features.incidentVertex=j}else{l=l*n+c.m_vertices[i].x;c=k*n+c.m_vertices[i].y;d.id.features.incidentEdge=i}e=e-l;f=f-c;c=Math.sqrt(e*e+f*f);e/=c;f/=c;if(!(c>h)){a.pointCount=1;a.normal.Set(g.col1.x*e+g.col2.x*f,g.col1.y*e+g.col2.y*
f);d.position.x=b.m_position.x-h*a.normal.x;d.position.y=b.m_position.y-h*a.normal.y;d.separation=c-h}}}};b2Collision.b2TestOverlap=function(a,c){var b=c.minVertex,d=a.maxVertex,e=b.x-d.x,f=b.y-d.y;b=a.minVertex;d=c.maxVertex;var g=b.y-d.y;if(e>0||f>0)return false;if(b.x-d.x>0||g>0)return false;return true};var Features=function(){};
Features.prototype={set_referenceFace:function(a){this._referenceFace=a;this._m_id._key=this._m_id._key&4294967040|this._referenceFace&255},get_referenceFace:function(){return this._referenceFace},_referenceFace:0,set_incidentEdge:function(a){this._incidentEdge=a;this._m_id._key=this._m_id._key&4294902015|this._incidentEdge<<8&65280},get_incidentEdge:function(){return this._incidentEdge},_incidentEdge:0,set_incidentVertex:function(a){this._incidentVertex=a;this._m_id._key=this._m_id._key&4278255615|
this._incidentVertex<<16&16711680},get_incidentVertex:function(){return this._incidentVertex},_incidentVertex:0,set_flip:function(a){this._flip=a;this._m_id._key=this._m_id._key&16777215|this._flip<<24&4278190080},get_flip:function(){return this._flip},_flip:0,_m_id:null};var b2ContactID=function(){this.features=new Features;this.features._m_id=this};
b2ContactID.prototype={Set:function(a){this.set_key(a._key)},Copy:function(){var a=new b2ContactID;a.set_key(this._key);return a},get_key:function(){return this._key},set_key:function(a){this._key=a;this.features._referenceFace=this._key&255;this.features._incidentEdge=(this._key&65280)>>8&255;this.features._incidentVertex=(this._key&16711680)>>16&255;this.features._flip=(this._key&4278190080)>>24&255},features:new Features,_key:0};var b2ContactPoint=function(){this.position=new b2Vec2;this.id=new b2ContactID};
b2ContactPoint.prototype={separation:null,normalImpulse:null,tangentImpulse:null};var b2Distance={};b2Distance.ProcessTwo=function(a,c,b,d,e){var f=-e[1].x,g=-e[1].y,h=e[0].x-e[1].x,i=e[0].y-e[1].y,j=Math.sqrt(h*h+i*i);h/=j;i/=j;f=f*h+g*i;if(f<=0||j<Number.MIN_VALUE){a.SetV(b[1]);c.SetV(d[1]);b[0].SetV(b[1]);d[0].SetV(d[1]);e[0].SetV(e[1]);return 1}f/=j;a.x=b[1].x+f*(b[0].x-b[1].x);a.y=b[1].y+f*(b[0].y-b[1].y);c.x=d[1].x+f*(d[0].x-d[1].x);c.y=d[1].y+f*(d[0].y-d[1].y);return 2};
b2Distance.ProcessThree=function(a,c,b,d,e){var f=e[0].x,g=e[0].y,h=e[1].x,i=e[1].y,j=e[2].x,k=e[2].y,l=h-f,m=i-g,n=j-f,o=k-g,q=j-h,r=k-i,p=-(f*n+g*o),s=j*n+k*o,v=-(h*q+i*r);q=j*q+k*r;if(s<=0&&q<=0){a.SetV(b[2]);c.SetV(d[2]);b[0].SetV(b[2]);d[0].SetV(d[2]);e[0].SetV(e[2]);return 1}m=l*o-m*n;l=m*(f*i-g*h);h=m*(h*k-i*j);if(h<=0&&v>=0&&q>=0){p=v/(v+q);a.x=b[1].x+p*(b[2].x-b[1].x);a.y=b[1].y+p*(b[2].y-b[1].y);c.x=d[1].x+p*(d[2].x-d[1].x);c.y=d[1].y+p*(d[2].y-d[1].y);b[0].SetV(b[2]);d[0].SetV(d[2]);e[0].SetV(e[2]);
return 2}f=m*(j*g-k*f);if(f<=0&&p>=0&&s>=0){p=p/(p+s);a.x=b[0].x+p*(b[2].x-b[0].x);a.y=b[0].y+p*(b[2].y-b[0].y);c.x=d[0].x+p*(d[2].x-d[0].x);c.y=d[0].y+p*(d[2].y-d[0].y);b[1].SetV(b[2]);d[1].SetV(d[2]);e[1].SetV(e[2]);return 2}p=h+f+l;p=1/p;e=h*p;p=f*p;s=1-e-p;a.x=e*b[0].x+p*b[1].x+s*b[2].x;a.y=e*b[0].y+p*b[1].y+s*b[2].y;c.x=e*d[0].x+p*d[1].x+s*d[2].x;c.y=e*d[0].y+p*d[1].y+s*d[2].y;return 3};b2Distance.InPoinsts=function(a,c,b){for(var d=0;d<b;++d)if(a.x==c[d].x&&a.y==c[d].y)return true;return false};
b2Distance.Distance=function(a,c,b,d){var e=Array(3),f=Array(3),g=Array(3),h=0;a.SetV(b.m_position);c.SetV(d.m_position);for(var i=0,j=0;j<20;++j){var k=c.x-a.x,l=c.y-a.y,m=b.Support(k,l),n=d.Support(-k,-l);i=k*k+l*l;var o=n.x-m.x,q=n.y-m.y;if(i-(k*o+l*q)<=0.01*i){if(h==0){a.SetV(m);c.SetV(n)}b2Distance.g_GJK_Iterations=j;return Math.sqrt(i)}switch(h){case 0:e[0].SetV(m);f[0].SetV(n);g[0].x=o;g[0].y=q;a.SetV(e[0]);c.SetV(f[0]);++h;break;case 1:e[1].SetV(m);f[1].SetV(n);g[1].x=o;g[1].y=q;h=b2Distance.ProcessTwo(a,
c,e,f,g);break;case 2:e[2].SetV(m);f[2].SetV(n);g[2].x=o;g[2].y=q;h=b2Distance.ProcessThree(a,c,e,f,g);break}if(h==3){b2Distance.g_GJK_Iterations=j;return 0}k=-Number.MAX_VALUE;for(l=0;l<h;++l)k=b2Math.b2Max(k,g[l].x*g[l].x+g[l].y*g[l].y);if(h==3||i<=100*Number.MIN_VALUE*k){b2Distance.g_GJK_Iterations=j;return Math.sqrt(i)}}b2Distance.g_GJK_Iterations=20;return Math.sqrt(i)};b2Distance.g_GJK_Iterations=0;
var b2Manifold=function(){this.points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.points[a]=new b2ContactPoint;this.normal=new b2Vec2};b2Manifold.prototype={points:null,normal:null,pointCount:0};var b2OBB=function(){this.R=new b2Mat22;this.center=new b2Vec2;this.extents=new b2Vec2},b2Proxy=Class.create();
b2Proxy.prototype={GetNext:function(){return this.lowerBounds[0]},SetNext:function(a){this.lowerBounds[0]=a},IsValid:function(){return this.overlapCount!=b2BroadPhase.b2_invalid},lowerBounds:[0,0],upperBounds:[0,0],overlapCount:0,timeStamp:0,userData:null,initialize:function(){this.lowerBounds=[0,0];this.upperBounds=[0,0]}};var ClipVertex=Class.create();ClipVertex.prototype={v:new b2Vec2,id:new b2ContactID,initialize:function(){this.v=new b2Vec2;this.id=new b2ContactID}};
var b2Shape=function(a,c){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=a.userData;this.m_friction=a.friction;this.m_restitution=a.restitution;this.m_body=c;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=a.categoryBits;this.m_maskBits=a.maskBits;this.m_groupIndex=a.groupIndex};
b2Shape.prototype={TestPoint:function(){return false},GetUserData:function(){return this.m_userData},GetType:function(){return this.m_type},GetBody:function(){return this.m_body},GetPosition:function(){return this.m_position},GetRotationMatrix:function(){return this.m_R},ResetProxy:function(){},GetNext:function(){return this.m_next},DestroyProxy:function(){if(this.m_proxyId!=b2Pair.b2_nullProxy){this.m_body.m_world.m_broadPhase.DestroyProxy(this.m_proxyId);this.m_proxyId=b2Pair.b2_nullProxy}},Synchronize:function(){},
QuickSync:function(){},Support:function(){},GetMaxRadius:function(){return this.m_maxRadius},m_next:null,m_R:new b2Mat22,m_position:new b2Vec2,m_type:0,m_userData:null,m_body:null,m_friction:null,m_restitution:null,m_maxRadius:null,m_proxyId:0,m_categoryBits:0,m_maskBits:0,m_groupIndex:0};b2Shape.Create=function(a,c,b){switch(a.type){case b2Shape.e_circleShape:return new b2CircleShape(a,c,b);case b2Shape.e_boxShape:case b2Shape.e_polyShape:return new b2PolyShape(a,c,b)}return null};
b2Shape.Destroy=function(a){a.m_proxyId!=b2Pair.b2_nullProxy&&a.m_body.m_world.m_broadPhase.DestroyProxy(a.m_proxyId)};b2Shape.e_unknownShape=-1;b2Shape.e_circleShape=0;b2Shape.e_boxShape=1;b2Shape.e_polyShape=2;b2Shape.e_meshShape=3;b2Shape.e_shapeTypeCount=4;
b2Shape.PolyMass=function(a,c,b,d){var e=new b2Vec2;e.SetZero();for(var f=0,g=0,h=new b2Vec2(0,0),i=1/3,j=0;j<b;++j){var k=h,l=c[j],m=j+1<b?c[j+1]:c[0],n=b2Math.SubtractVV(l,k),o=b2Math.SubtractVV(m,k),q=b2Math.b2CrossVV(n,o),r=0.5*q;f+=r;var p=new b2Vec2;p.SetV(k);p.Add(l);p.Add(m);p.Multiply(i*r);e.Add(p);l=k.x;k=k.y;m=n.x;n=n.y;r=o.x;o=o.y;g+=q*(i*(0.25*(m*m+r*m+r*r)+(l*m+l*r))+0.5*l*l+(i*(0.25*(n*n+o*n+o*o)+(k*n+k*o))+0.5*k*k))}a.mass=d*f;e.Multiply(1/f);a.center=e;g=d*(g-f*b2Math.b2Dot(e,e));
a.I=g};b2Shape.PolyCentroid=function(a,c,b){for(var d=0,e=0,f=0,g=1/3,h=0;h<c;++h){var i=a[h].x,j=a[h].y,k=h+1<c?a[h+1].x:a[0].x,l=h+1<c?a[h+1].y:a[0].y,m=0.5*((i-0)*(l-0)-(j-0)*(k-0));f+=m;d+=m*g*(0+i+k);e+=m*g*(0+j+l)}d*=1/f;e*=1/f;b.Set(d,e)};var b2ShapeDef=function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=0.2;this.density=this.restitution=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0};
b2ShapeDef.prototype.ComputeMass=function(a){a.center=new b2Vec2(0,0);if(this.density==0){a.mass=0;a.center.Set(0,0);a.I=0}switch(this.type){case b2Shape.e_circleShape:a.mass=this.density*b2Settings.b2_pi*this.radius*this.radius;a.center.Set(0,0);a.I=0.5*a.mass*this.radius*this.radius;break;case b2Shape.e_boxShape:a.mass=4*this.density*this.extents.x*this.extents.y;a.center.Set(0,0);a.I=a.mass/3*b2Math.b2Dot(this.extents,this.extents);break;case b2Shape.e_polyShape:b2Shape.PolyMass(a,this.vertices,
this.vertexCount,this.density);break;default:a.mass=0;a.center.Set(0,0);a.I=0;break}};b2ShapeDef.prototype.type=0;b2ShapeDef.prototype.userData=null;b2ShapeDef.prototype.localPosition=null;b2ShapeDef.prototype.localRotation=null;b2ShapeDef.prototype.friction=null;b2ShapeDef.prototype.restitution=null;b2ShapeDef.prototype.density=null;b2ShapeDef.prototype.categoryBits=0;b2ShapeDef.prototype.maskBits=0;b2ShapeDef.prototype.groupIndex=0;
var b2BoxDef=function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=0.2;this.density=this.restitution=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_boxShape;this.extents=new b2Vec2(1,1)};goog.inherits(b2BoxDef,b2ShapeDef);
var b2CircleDef=function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=0.2;this.density=this.restitution=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.type=b2Shape.e_circleShape;this.radius=1};goog.inherits(b2CircleDef,b2ShapeDef);
var b2CircleShape=function(a,c,b){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=a.userData;this.m_friction=a.friction;this.m_restitution=a.restitution;this.m_body=c;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=a.categoryBits;this.m_maskBits=a.maskBits;this.m_groupIndex=a.groupIndex;this.m_localPosition=new b2Vec2;this.m_localPosition.Set(a.localPosition.x-b.x,a.localPosition.y-b.y);this.m_type=b2Shape.e_circleShape;this.m_radius=a.radius;this.m_R.SetM(this.m_body.m_R);
a=this.m_R.col1.x*this.m_localPosition.x+this.m_R.col2.x*this.m_localPosition.y;c=this.m_R.col1.y*this.m_localPosition.x+this.m_R.col2.y*this.m_localPosition.y;this.m_position.x=this.m_body.m_position.x+a;this.m_position.y=this.m_body.m_position.y+c;this.m_maxRadius=Math.sqrt(a*a+c*c)+this.m_radius;a=new b2AABB;a.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius);a.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius);c=this.m_body.m_world.m_broadPhase;
this.m_proxyId=c.InRange(a)?c.CreateProxy(a,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()};goog.inherits(b2CircleShape,b2Shape);b2CircleShape.prototype.TestPoint=function(a){var c=new b2Vec2;c.SetV(a);c.Subtract(this.m_position);return b2Math.b2Dot(c,c)<=this.m_radius*this.m_radius};
b2CircleShape.prototype.Synchronize=function(a,c,b,d){this.m_R.SetM(d);this.m_position.x=d.col1.x*this.m_localPosition.x+d.col2.x*this.m_localPosition.y+b.x;this.m_position.y=d.col1.y*this.m_localPosition.x+d.col2.y*this.m_localPosition.y+b.y;if(this.m_proxyId!=b2Pair.b2_nullProxy){b=a.x+(c.col1.x*this.m_localPosition.x+c.col2.x*this.m_localPosition.y);d=a.y+(c.col1.y*this.m_localPosition.x+c.col2.y*this.m_localPosition.y);a=Math.min(b,this.m_position.x);c=Math.min(d,this.m_position.y);b=Math.max(b,
this.m_position.x);var e=Math.max(d,this.m_position.y);d=new b2AABB;d.minVertex.Set(a-this.m_radius,c-this.m_radius);d.maxVertex.Set(b+this.m_radius,e+this.m_radius);a=this.m_body.m_world.m_broadPhase;a.InRange(d)?a.MoveProxy(this.m_proxyId,d):this.m_body.Freeze()}};b2CircleShape.prototype.QuickSync=function(a,c){this.m_R.SetM(c);this.m_position.x=c.col1.x*this.m_localPosition.x+c.col2.x*this.m_localPosition.y+a.x;this.m_position.y=c.col1.y*this.m_localPosition.x+c.col2.y*this.m_localPosition.y+a.y};
b2CircleShape.prototype.ResetProxy=function(a){if(this.m_proxyId!=b2Pair.b2_nullProxy){a.GetProxy(this.m_proxyId);a.DestroyProxy(this.m_proxyId);var c=new b2AABB;c.minVertex.Set(this.m_position.x-this.m_radius,this.m_position.y-this.m_radius);c.maxVertex.Set(this.m_position.x+this.m_radius,this.m_position.y+this.m_radius);this.m_proxyId=a.InRange(c)?a.CreateProxy(c,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()}};
b2CircleShape.prototype.Support=function(a,c,b){var d=Math.sqrt(a*a+c*c);a/=d;c/=d;b.Set(this.m_position.x+this.m_radius*a,this.m_position.y+this.m_radius*c)};var b2MassData=function(){this.center=new b2Vec2(0,0)};b2MassData.prototype={mass:0,center:new b2Vec2(0,0),I:0};
var b2PolyDef=function(){this.type=b2Shape.e_unknownShape;this.userData=null;this.localPosition=new b2Vec2(0,0);this.localRotation=0;this.friction=0.2;this.density=this.restitution=0;this.categoryBits=1;this.maskBits=65535;this.groupIndex=0;this.vertices=Array(b2Settings.b2_maxPolyVertices);this.type=b2Shape.e_polyShape;for(var a=this.vertexCount=0;a<b2Settings.b2_maxPolyVertices;a++)this.vertices[a]=new b2Vec2};goog.inherits(b2PolyDef,b2ShapeDef);
b2PolyDef.prototype.SetVertices=function(a){this.vertexCount=a.length;for(var c=0;c<a.length;c++)this.vertices[c].Set(a[c][0],a[c][1])};
var b2PolyShape=function(a,c,b){this.m_R=new b2Mat22;this.m_position=new b2Vec2;this.m_userData=a.userData;this.m_friction=a.friction;this.m_restitution=a.restitution;this.m_body=c;this.m_proxyId=b2Pair.b2_nullProxy;this.m_maxRadius=0;this.m_categoryBits=a.categoryBits;this.m_maskBits=a.maskBits;this.m_groupIndex=a.groupIndex;this.syncAABB=new b2AABB;this.syncMat=new b2Mat22;this.m_localCentroid=new b2Vec2;this.m_localOBB=new b2OBB;var d=0,e;c=new b2AABB;this.m_vertices=Array(b2Settings.b2_maxPolyVertices);
this.m_coreVertices=Array(b2Settings.b2_maxPolyVertices);this.m_normals=Array(b2Settings.b2_maxPolyVertices);this.m_type=b2Shape.e_polyShape;var f=new b2Mat22(a.localRotation);if(a.type==b2Shape.e_boxShape){this.m_localCentroid.x=a.localPosition.x-b.x;this.m_localCentroid.y=a.localPosition.y-b.y;this.m_vertexCount=4;b=a.extents.x;e=a.extents.y;a=Math.max(0,b-2*b2Settings.b2_linearSlop);var g=Math.max(0,e-2*b2Settings.b2_linearSlop);d=this.m_vertices[0]=new b2Vec2;d.x=f.col1.x*b+f.col2.x*e;d.y=f.col1.y*
b+f.col2.y*e;d=this.m_vertices[1]=new b2Vec2;d.x=f.col1.x*-b+f.col2.x*e;d.y=f.col1.y*-b+f.col2.y*e;d=this.m_vertices[2]=new b2Vec2;d.x=f.col1.x*-b+f.col2.x*-e;d.y=f.col1.y*-b+f.col2.y*-e;d=this.m_vertices[3]=new b2Vec2;d.x=f.col1.x*b+f.col2.x*-e;d.y=f.col1.y*b+f.col2.y*-e;d=this.m_coreVertices[0]=new b2Vec2;d.x=f.col1.x*a+f.col2.x*g;d.y=f.col1.y*a+f.col2.y*g;d=this.m_coreVertices[1]=new b2Vec2;d.x=f.col1.x*-a+f.col2.x*g;d.y=f.col1.y*-a+f.col2.y*g;d=this.m_coreVertices[2]=new b2Vec2;d.x=f.col1.x*-a+
f.col2.x*-g;d.y=f.col1.y*-a+f.col2.y*-g;d=this.m_coreVertices[3]=new b2Vec2;d.x=f.col1.x*a+f.col2.x*-g;d.y=f.col1.y*a+f.col2.y*-g}else{this.m_vertexCount=a.vertexCount;b2Shape.PolyCentroid(a.vertices,a.vertexCount,b2PolyShape.tempVec);g=b2PolyShape.tempVec.x;var h=b2PolyShape.tempVec.y;this.m_localCentroid.x=a.localPosition.x+(f.col1.x*g+f.col2.x*h)-b.x;this.m_localCentroid.y=a.localPosition.y+(f.col1.y*g+f.col2.y*h)-b.y;for(d=0;d<this.m_vertexCount;++d){this.m_vertices[d]=new b2Vec2;this.m_coreVertices[d]=
new b2Vec2;b=a.vertices[d].x-g;e=a.vertices[d].y-h;this.m_vertices[d].x=f.col1.x*b+f.col2.x*e;this.m_vertices[d].y=f.col1.y*b+f.col2.y*e;b=this.m_vertices[d].x;e=this.m_vertices[d].y;var i=Math.sqrt(b*b+e*e);if(i>Number.MIN_VALUE){b*=1/i;e*=1/i}this.m_coreVertices[d].x=this.m_vertices[d].x-2*b2Settings.b2_linearSlop*b;this.m_coreVertices[d].y=this.m_vertices[d].y-2*b2Settings.b2_linearSlop*e}}a=f=Number.MAX_VALUE;b=-Number.MAX_VALUE;e=-Number.MAX_VALUE;for(d=this.m_maxRadius=0;d<this.m_vertexCount;++d){g=
this.m_vertices[d];f=Math.min(f,g.x);a=Math.min(a,g.y);b=Math.max(b,g.x);e=Math.max(e,g.y);this.m_maxRadius=Math.max(this.m_maxRadius,g.Length())}this.m_localOBB.R.SetIdentity();this.m_localOBB.center.Set((f+b)*0.5,(a+e)*0.5);this.m_localOBB.extents.Set((b-f)*0.5,(e-a)*0.5);for(d=a=f=0;d<this.m_vertexCount;++d){this.m_normals[d]=new b2Vec2;f=d;a=d+1<this.m_vertexCount?d+1:0;this.m_normals[d].x=this.m_vertices[a].y-this.m_vertices[f].y;this.m_normals[d].y=-(this.m_vertices[a].x-this.m_vertices[f].x);
this.m_normals[d].Normalize()}for(d=0;d<this.m_vertexCount;++d);this.m_R.SetM(this.m_body.m_R);this.m_position.x=this.m_body.m_position.x+(this.m_R.col1.x*this.m_localCentroid.x+this.m_R.col2.x*this.m_localCentroid.y);this.m_position.y=this.m_body.m_position.y+(this.m_R.col1.y*this.m_localCentroid.x+this.m_R.col2.y*this.m_localCentroid.y);b2PolyShape.tAbsR.col1.x=this.m_R.col1.x*this.m_localOBB.R.col1.x+this.m_R.col2.x*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col1.y=this.m_R.col1.y*this.m_localOBB.R.col1.x+
this.m_R.col2.y*this.m_localOBB.R.col1.y;b2PolyShape.tAbsR.col2.x=this.m_R.col1.x*this.m_localOBB.R.col2.x+this.m_R.col2.x*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.col2.y=this.m_R.col1.y*this.m_localOBB.R.col2.x+this.m_R.col2.y*this.m_localOBB.R.col2.y;b2PolyShape.tAbsR.Abs();b=b2PolyShape.tAbsR.col1.x*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.x*this.m_localOBB.extents.y;e=b2PolyShape.tAbsR.col1.y*this.m_localOBB.extents.x+b2PolyShape.tAbsR.col2.y*this.m_localOBB.extents.y;d=this.m_position.x+
(this.m_R.col1.x*this.m_localOBB.center.x+this.m_R.col2.x*this.m_localOBB.center.y);f=this.m_position.y+(this.m_R.col1.y*this.m_localOBB.center.x+this.m_R.col2.y*this.m_localOBB.center.y);c.minVertex.x=d-b;c.minVertex.y=f-e;c.maxVertex.x=d+b;c.maxVertex.y=f+e;d=this.m_body.m_world.m_broadPhase;this.m_proxyId=d.InRange(c)?d.CreateProxy(c,this):b2Pair.b2_nullProxy;this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()};goog.inherits(b2PolyShape,b2Shape);
b2PolyShape.prototype.TestPoint=function(a){var c=new b2Vec2;c.SetV(a);c.Subtract(this.m_position);c.MulTM(this.m_R);for(a=0;a<this.m_vertexCount;++a){var b=new b2Vec2;b.SetV(c);b.Subtract(this.m_vertices[a]);if(b2Math.b2Dot(this.m_normals[a],b)>0)return false}return true};b2PolyShape.prototype.syncAABB=new b2AABB;b2PolyShape.prototype.syncMat=new b2Mat22;
b2PolyShape.prototype.Synchronize=function(a,c,b,d){this.m_R.SetM(d);this.m_position.x=this.m_body.m_position.x+(d.col1.x*this.m_localCentroid.x+d.col2.x*this.m_localCentroid.y);this.m_position.y=this.m_body.m_position.y+(d.col1.y*this.m_localCentroid.x+d.col2.y*this.m_localCentroid.y);if(this.m_proxyId!=b2Pair.b2_nullProxy){var e,f;e=c.col1;f=c.col2;var g=this.m_localOBB.R.col1,h=this.m_localOBB.R.col2;this.syncMat.col1.x=e.x*g.x+f.x*g.y;this.syncMat.col1.y=e.y*g.x+f.y*g.y;this.syncMat.col2.x=e.x*
h.x+f.x*h.y;this.syncMat.col2.y=e.y*h.x+f.y*h.y;this.syncMat.Abs();e=this.m_localCentroid.x+this.m_localOBB.center.x;f=this.m_localCentroid.y+this.m_localOBB.center.y;g=a.x+(c.col1.x*e+c.col2.x*f);a=a.y+(c.col1.y*e+c.col2.y*f);e=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;f=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=g-e;this.syncAABB.minVertex.y=a-f;this.syncAABB.maxVertex.x=
g+e;this.syncAABB.maxVertex.y=a+f;e=d.col1;f=d.col2;g=this.m_localOBB.R.col1;h=this.m_localOBB.R.col2;this.syncMat.col1.x=e.x*g.x+f.x*g.y;this.syncMat.col1.y=e.y*g.x+f.y*g.y;this.syncMat.col2.x=e.x*h.x+f.x*h.y;this.syncMat.col2.y=e.y*h.x+f.y*h.y;this.syncMat.Abs();e=this.m_localCentroid.x+this.m_localOBB.center.x;f=this.m_localCentroid.y+this.m_localOBB.center.y;g=b.x+(d.col1.x*e+d.col2.x*f);a=b.y+(d.col1.y*e+d.col2.y*f);e=this.syncMat.col1.x*this.m_localOBB.extents.x+this.syncMat.col2.x*this.m_localOBB.extents.y;
f=this.syncMat.col1.y*this.m_localOBB.extents.x+this.syncMat.col2.y*this.m_localOBB.extents.y;this.syncAABB.minVertex.x=Math.min(this.syncAABB.minVertex.x,g-e);this.syncAABB.minVertex.y=Math.min(this.syncAABB.minVertex.y,a-f);this.syncAABB.maxVertex.x=Math.max(this.syncAABB.maxVertex.x,g+e);this.syncAABB.maxVertex.y=Math.max(this.syncAABB.maxVertex.y,a+f);b=this.m_body.m_world.m_broadPhase;b.InRange(this.syncAABB)?b.MoveProxy(this.m_proxyId,this.syncAABB):this.m_body.Freeze()}};
b2PolyShape.prototype.QuickSync=function(a,c){this.m_R.SetM(c);this.m_position.x=a.x+(c.col1.x*this.m_localCentroid.x+c.col2.x*this.m_localCentroid.y);this.m_position.y=a.y+(c.col1.y*this.m_localCentroid.x+c.col2.y*this.m_localCentroid.y)};
b2PolyShape.prototype.ResetProxy=function(a){if(this.m_proxyId!=b2Pair.b2_nullProxy){a.GetProxy(this.m_proxyId);a.DestroyProxy(this.m_proxyId);var c=b2Math.b2MulMM(this.m_R,this.m_localOBB.R);c=b2Math.b2AbsM(c);c=b2Math.b2MulMV(c,this.m_localOBB.extents);var b=b2Math.b2MulMV(this.m_R,this.m_localOBB.center);b.Add(this.m_position);var d=new b2AABB;d.minVertex.SetV(b);d.minVertex.Subtract(c);d.maxVertex.SetV(b);d.maxVertex.Add(c);this.m_proxyId=a.InRange(d)?a.CreateProxy(d,this):b2Pair.b2_nullProxy;
this.m_proxyId==b2Pair.b2_nullProxy&&this.m_body.Freeze()}};
b2PolyShape.prototype.Support=function(a,c,b){var d=a*this.m_R.col1.x+c*this.m_R.col1.y;a=a*this.m_R.col2.x+c*this.m_R.col2.y;c=0;for(var e=this.m_coreVertices[0].x*d+this.m_coreVertices[0].y*a,f=1;f<this.m_vertexCount;++f){var g=this.m_coreVertices[f].x*d+this.m_coreVertices[f].y*a;if(g>e){c=f;e=g}}b.Set(this.m_position.x+(this.m_R.col1.x*this.m_coreVertices[c].x+this.m_R.col2.x*this.m_coreVertices[c].y),this.m_position.y+(this.m_R.col1.y*this.m_coreVertices[c].x+this.m_R.col2.y*this.m_coreVertices[c].y))};
b2PolyShape.tempVec=new b2Vec2;b2PolyShape.tAbsR=new b2Mat22;var b2Body=Class.create();
b2Body.prototype={SetOriginPosition:function(a,c){if(!this.IsFrozen()){this.m_rotation=c;this.m_R.Set(this.m_rotation);this.m_position=b2Math.AddVV(a,b2Math.b2MulMV(this.m_R,this.m_center));this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var b=this.m_shapeList;b!=null;b=b.m_next)b.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R);this.m_world.m_broadPhase.Commit()}},GetOriginPosition:function(){return b2Math.SubtractVV(this.m_position,b2Math.b2MulMV(this.m_R,
this.m_center))},SetCenterPosition:function(a,c){if(!this.IsFrozen()){this.m_rotation=c;this.m_R.Set(this.m_rotation);this.m_position.SetV(a);this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;for(var b=this.m_shapeList;b!=null;b=b.m_next)b.Synchronize(this.m_position,this.m_R,this.m_position,this.m_R);this.m_world.m_broadPhase.Commit()}},GetCenterPosition:function(){return this.m_position},GetRotation:function(){return this.m_rotation},GetRotationMatrix:function(){return this.m_R},
SetLinearVelocity:function(a){this.m_linearVelocity.SetV(a)},GetLinearVelocity:function(){return this.m_linearVelocity},SetAngularVelocity:function(a){this.m_angularVelocity=a},GetAngularVelocity:function(){return this.m_angularVelocity},ApplyForce:function(a,c){if(this.IsSleeping()==false){this.m_force.Add(a);this.m_torque+=b2Math.b2CrossVV(b2Math.SubtractVV(c,this.m_position),a)}},ApplyTorque:function(a){if(this.IsSleeping()==false)this.m_torque+=a},ApplyImpulse:function(a,c){if(this.IsSleeping()==
false){this.m_linearVelocity.Add(b2Math.MulFV(this.m_invMass,a));this.m_angularVelocity+=this.m_invI*b2Math.b2CrossVV(b2Math.SubtractVV(c,this.m_position),a)}},GetMass:function(){return this.m_mass},GetInertia:function(){return this.m_I},GetWorldPoint:function(a){return b2Math.AddVV(this.m_position,b2Math.b2MulMV(this.m_R,a))},GetWorldVector:function(a){return b2Math.b2MulMV(this.m_R,a)},GetLocalPoint:function(a){return b2Math.b2MulTMV(this.m_R,b2Math.SubtractVV(a,this.m_position))},GetLocalVector:function(a){return b2Math.b2MulTMV(this.m_R,
a)},IsStatic:function(){return(this.m_flags&b2Body.e_staticFlag)==b2Body.e_staticFlag},IsFrozen:function(){return(this.m_flags&b2Body.e_frozenFlag)==b2Body.e_frozenFlag},IsSleeping:function(){return(this.m_flags&b2Body.e_sleepFlag)==b2Body.e_sleepFlag},AllowSleeping:function(a){if(a)this.m_flags|=b2Body.e_allowSleepFlag;else{this.m_flags&=~b2Body.e_allowSleepFlag;this.WakeUp()}},WakeUp:function(){this.m_flags&=~b2Body.e_sleepFlag;this.m_sleepTime=0},GetShapeList:function(){return this.m_shapeList},
GetContactList:function(){return this.m_contactList},GetJointList:function(){return this.m_jointList},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(a,c){this.sMat0=new b2Mat22;this.m_position=new b2Vec2;this.m_R=new b2Mat22(0);this.m_position0=new b2Vec2;var b=0,d,e;this.m_flags=0;this.m_position.SetV(a.position);this.m_rotation=a.rotation;this.m_R.Set(this.m_rotation);this.m_position0.SetV(this.m_position);this.m_rotation0=this.m_rotation;
this.m_world=c;this.m_linearDamping=b2Math.b2Clamp(1-a.linearDamping,0,1);this.m_angularDamping=b2Math.b2Clamp(1-a.angularDamping,0,1);this.m_force=new b2Vec2(0,0);this.m_mass=this.m_torque=0;var f=Array(b2Settings.b2_maxShapesPerBody);for(b=0;b<b2Settings.b2_maxShapesPerBody;b++)f[b]=new b2MassData;this.m_shapeCount=0;this.m_center=new b2Vec2(0,0);for(b=0;b<b2Settings.b2_maxShapesPerBody;++b){d=a.shapes[b];if(d==null)break;e=f[b];d.ComputeMass(e);this.m_mass+=e.mass;this.m_center.x+=e.mass*(d.localPosition.x+
e.center.x);this.m_center.y+=e.mass*(d.localPosition.y+e.center.y);++this.m_shapeCount}if(this.m_mass>0){this.m_center.Multiply(1/this.m_mass);this.m_position.Add(b2Math.b2MulMV(this.m_R,this.m_center))}else this.m_flags|=b2Body.e_staticFlag;for(b=this.m_I=0;b<this.m_shapeCount;++b){d=a.shapes[b];e=f[b];this.m_I+=e.I;d=b2Math.SubtractVV(b2Math.AddVV(d.localPosition,e.center),this.m_center);this.m_I+=e.mass*b2Math.b2Dot(d,d)}this.m_invMass=this.m_mass>0?1/this.m_mass:0;if(this.m_I>0&&a.preventRotation==
false)this.m_invI=1/this.m_I;else this.m_invI=this.m_I=0;this.m_linearVelocity=b2Math.AddVV(a.linearVelocity,b2Math.b2CrossFV(a.angularVelocity,this.m_center));this.m_angularVelocity=a.angularVelocity;this.m_shapeList=this.m_next=this.m_prev=this.m_contactList=this.m_jointList=null;for(b=0;b<this.m_shapeCount;++b){d=a.shapes[b];e=b2Shape.Create(d,this,this.m_center);e.m_next=this.m_shapeList;this.m_shapeList=e}this.m_sleepTime=0;if(a.allowSleep)this.m_flags|=b2Body.e_allowSleepFlag;if(a.isSleeping)this.m_flags|=
b2Body.e_sleepFlag;if(this.m_flags&b2Body.e_sleepFlag||this.m_invMass==0){this.m_linearVelocity.Set(0,0);this.m_angularVelocity=0}this.m_userData=a.userData},Destroy:function(){for(var a=this.m_shapeList;a;){var c=a;a=a.m_next;b2Shape.Destroy(c)}},sMat0:new b2Mat22,SynchronizeShapes:function(){this.sMat0.Set(this.m_rotation0);for(var a=this.m_shapeList;a!=null;a=a.m_next)a.Synchronize(this.m_position0,this.sMat0,this.m_position,this.m_R)},QuickSyncShapes:function(){for(var a=this.m_shapeList;a!=null;a=
a.m_next)a.QuickSync(this.m_position,this.m_R)},IsConnected:function(a){for(var c=this.m_jointList;c!=null;c=c.next)if(c.other==a)return c.joint.m_collideConnected==false;return false},Freeze:function(){this.m_flags|=b2Body.e_frozenFlag;this.m_linearVelocity.SetZero();this.m_angularVelocity=0;for(var a=this.m_shapeList;a!=null;a=a.m_next)a.DestroyProxy()},m_flags:0,m_position:new b2Vec2,m_rotation:null,m_R:new b2Mat22(0),m_position0:new b2Vec2,m_rotation0:null,m_linearVelocity:null,m_angularVelocity:null,
m_force:null,m_torque:null,m_center:null,m_world:null,m_prev:null,m_next:null,m_shapeList:null,m_shapeCount:0,m_jointList:null,m_contactList:null,m_mass:null,m_invMass:null,m_I:null,m_invI:null,m_linearDamping:null,m_angularDamping:null,m_sleepTime:null,m_userData:null};b2Body.e_staticFlag=1;b2Body.e_frozenFlag=2;b2Body.e_islandFlag=4;b2Body.e_sleepFlag=8;b2Body.e_allowSleepFlag=16;b2Body.e_destroyFlag=32;
var b2BodyDef=function(){this.shapes=[];this.userData=null;for(var a=0;a<b2Settings.b2_maxShapesPerBody;a++)this.shapes[a]=null;this.position=new b2Vec2(0,0);this.rotation=0;this.linearVelocity=new b2Vec2(0,0);this.angularDamping=this.linearDamping=this.angularVelocity=0;this.allowSleep=true;this.preventRotation=this.isSleeping=false};
b2BodyDef.prototype={userData:null,shapes:[],position:null,rotation:null,linearVelocity:null,angularVelocity:null,linearDamping:null,angularDamping:null,allowSleep:null,isSleeping:null,preventRotation:null,AddShape:function(a){for(var c=0;c<b2Settings.b2_maxShapesPerBody;++c)if(this.shapes[c]==null){this.shapes[c]=a;break}}};var b2CollisionFilter=function(){};
b2CollisionFilter.prototype.ShouldCollide=function(a,c){if(a.m_groupIndex==c.m_groupIndex&&a.m_groupIndex!=0)return a.m_groupIndex>0;return(a.m_maskBits&c.m_categoryBits)!=0&&(a.m_categoryBits&c.m_maskBits)!=0};b2CollisionFilter.b2_defaultFilter=new b2CollisionFilter;var b2Island=Class.create();
b2Island.prototype={initialize:function(a,c,b,d){var e=0;this.m_bodyCapacity=a;this.m_contactCapacity=c;this.m_jointCapacity=b;this.m_jointCount=this.m_contactCount=this.m_bodyCount=0;this.m_bodies=Array(a);for(e=0;e<a;e++)this.m_bodies[e]=null;this.m_contacts=Array(c);for(e=0;e<c;e++)this.m_contacts[e]=null;this.m_joints=Array(b);for(e=0;e<b;e++)this.m_joints[e]=null;this.m_allocator=d},Clear:function(){this.m_jointCount=this.m_contactCount=this.m_bodyCount=0},Solve:function(a,c){var b=0,d;for(b=
0;b<this.m_bodyCount;++b){d=this.m_bodies[b];if(d.m_invMass!=0){d.m_linearVelocity.Add(b2Math.MulFV(a.dt,b2Math.AddVV(c,b2Math.MulFV(d.m_invMass,d.m_force))));d.m_angularVelocity+=a.dt*d.m_invI*d.m_torque;d.m_linearVelocity.Multiply(d.m_linearDamping);d.m_angularVelocity*=d.m_angularDamping;d.m_position0.SetV(d.m_position);d.m_rotation0=d.m_rotation}}var e=new b2ContactSolver(this.m_contacts,this.m_contactCount,this.m_allocator);e.PreSolve();for(b=0;b<this.m_jointCount;++b)this.m_joints[b].PrepareVelocitySolver();
for(b=0;b<a.iterations;++b){e.SolveVelocityConstraints();for(d=0;d<this.m_jointCount;++d)this.m_joints[d].SolveVelocityConstraints(a)}for(b=0;b<this.m_bodyCount;++b){d=this.m_bodies[b];if(d.m_invMass!=0){d.m_position.x+=a.dt*d.m_linearVelocity.x;d.m_position.y+=a.dt*d.m_linearVelocity.y;d.m_rotation+=a.dt*d.m_angularVelocity;d.m_R.Set(d.m_rotation)}}for(b=0;b<this.m_jointCount;++b)this.m_joints[b].PreparePositionSolver();if(b2World.s_enablePositionCorrection)for(b2Island.m_positionIterationCount=
0;b2Island.m_positionIterationCount<a.iterations;++b2Island.m_positionIterationCount){d=e.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);var f=true;for(b=0;b<this.m_jointCount;++b){var g=this.m_joints[b].SolvePositionConstraints();f=f&&g}if(d&&f)break}e.PostSolve();for(b=0;b<this.m_bodyCount;++b){d=this.m_bodies[b];if(d.m_invMass!=0){d.m_R.Set(d.m_rotation);d.SynchronizeShapes();d.m_force.Set(0,0);d.m_torque=0}}},UpdateSleep:function(a){var c=0,b,d=Number.MAX_VALUE,e=b2Settings.b2_linearSleepTolerance*
b2Settings.b2_linearSleepTolerance,f=b2Settings.b2_angularSleepTolerance*b2Settings.b2_angularSleepTolerance;for(c=0;c<this.m_bodyCount;++c){b=this.m_bodies[c];if(b.m_invMass!=0){if((b.m_flags&b2Body.e_allowSleepFlag)==0)d=b.m_sleepTime=0;if((b.m_flags&b2Body.e_allowSleepFlag)==0||b.m_angularVelocity*b.m_angularVelocity>f||b2Math.b2Dot(b.m_linearVelocity,b.m_linearVelocity)>e)d=b.m_sleepTime=0;else{b.m_sleepTime+=a;d=b2Math.b2Min(d,b.m_sleepTime)}}}if(d>=b2Settings.b2_timeToSleep)for(c=0;c<this.m_bodyCount;++c){b=
this.m_bodies[c];b.m_flags|=b2Body.e_sleepFlag}},AddBody:function(a){this.m_bodies[this.m_bodyCount++]=a},AddContact:function(a){this.m_contacts[this.m_contactCount++]=a},AddJoint:function(a){this.m_joints[this.m_jointCount++]=a},m_allocator:null,m_bodies:null,m_contacts:null,m_joints:null,m_bodyCount:0,m_jointCount:0,m_contactCount:0,m_bodyCapacity:0,m_contactCapacity:0,m_jointCapacity:0,m_positionError:null};b2Island.m_positionIterationCount=0;var b2TimeStep=Class.create();
b2TimeStep.prototype={dt:null,inv_dt:null,iterations:0,initialize:function(){}};var b2ContactNode=Class.create();b2ContactNode.prototype={other:null,contact:null,prev:null,next:null,initialize:function(){}};
var b2Contact=function(a,c){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!a||!c)this.m_shape2=this.m_shape1=null;else{this.m_shape1=a;this.m_shape2=c;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_next=this.m_prev=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;this.m_node2.contact=
null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null}};b2Contact.prototype={GetManifolds:function(){return null},GetManifoldCount:function(){return this.m_manifoldCount},GetNext:function(){return this.m_next},GetShape1:function(){return this.m_shape1},GetShape2:function(){return this.m_shape2},Evaluate:function(){},m_flags:0,m_prev:null,m_next:null,m_node1:new b2ContactNode,m_node2:new b2ContactNode,m_shape1:null,m_shape2:null,m_manifoldCount:0,m_friction:null,m_restitution:null};
b2Contact.e_islandFlag=1;b2Contact.e_destroyFlag=2;b2Contact.AddType=function(a,c,b,d){b2Contact.s_registers[b][d].createFcn=a;b2Contact.s_registers[b][d].destroyFcn=c;b2Contact.s_registers[b][d].primary=true;if(b!=d){b2Contact.s_registers[d][b].createFcn=a;b2Contact.s_registers[d][b].destroyFcn=c;b2Contact.s_registers[d][b].primary=false}};
b2Contact.InitializeRegisters=function(){b2Contact.s_registers=Array(b2Shape.e_shapeTypeCount);for(var a=0;a<b2Shape.e_shapeTypeCount;a++){b2Contact.s_registers[a]=Array(b2Shape.e_shapeTypeCount);for(var c=0;c<b2Shape.e_shapeTypeCount;c++)b2Contact.s_registers[a][c]=new b2ContactRegister}b2Contact.AddType(b2CircleContact.Create,b2CircleContact.Destroy,b2Shape.e_circleShape,b2Shape.e_circleShape);b2Contact.AddType(b2PolyAndCircleContact.Create,b2PolyAndCircleContact.Destroy,b2Shape.e_polyShape,b2Shape.e_circleShape);
b2Contact.AddType(b2PolyContact.Create,b2PolyContact.Destroy,b2Shape.e_polyShape,b2Shape.e_polyShape)};b2Contact.Create=function(a,c,b){if(b2Contact.s_initialized==false){b2Contact.InitializeRegisters();b2Contact.s_initialized=true}var d=a.m_type,e=c.m_type,f=b2Contact.s_registers[d][e].createFcn;if(f)if(b2Contact.s_registers[d][e].primary)return f(a,c,b);else{a=f(c,a,b);for(c=0;c<a.GetManifoldCount();++c){b=a.GetManifolds()[c];b.normal=b.normal.Negative()}return a}else return null};
b2Contact.Destroy=function(a,c){if(a.GetManifoldCount()>0){a.m_shape1.m_body.WakeUp();a.m_shape2.m_body.WakeUp()}var b=b2Contact.s_registers[a.m_shape1.m_type][a.m_shape2.m_type].destroyFcn;b(a,c)};b2Contact.s_registers=null;b2Contact.s_initialized=false;var b2ContactConstraint=Class.create();
b2ContactConstraint.prototype={initialize:function(){this.normal=new b2Vec2;this.points=Array(b2Settings.b2_maxManifoldPoints);for(var a=0;a<b2Settings.b2_maxManifoldPoints;a++)this.points[a]=new b2ContactConstraintPoint},points:null,normal:new b2Vec2,manifold:null,body1:null,body2:null,friction:null,restitution:null,pointCount:0};var b2ContactConstraintPoint=Class.create();
b2ContactConstraintPoint.prototype={localAnchor1:new b2Vec2,localAnchor2:new b2Vec2,normalImpulse:null,tangentImpulse:null,positionImpulse:null,normalMass:null,tangentMass:null,separation:null,velocityBias:null,initialize:function(){this.localAnchor1=new b2Vec2;this.localAnchor2=new b2Vec2}};var b2ContactRegister=Class.create();b2ContactRegister.prototype={createFcn:null,destroyFcn:null,primary:null,initialize:function(){}};var b2ContactSolver=Class.create();
b2ContactSolver.prototype={initialize:function(a,c,b){this.m_constraints=[];this.m_allocator=b;b=0;var d,e;for(b=this.m_constraintCount=0;b<c;++b)this.m_constraintCount+=a[b].GetManifoldCount();for(b=0;b<this.m_constraintCount;b++)this.m_constraints[b]=new b2ContactConstraint;var f=0;for(b=0;b<c;++b){var g=a[b],h=g.m_shape1.m_body,i=g.m_shape2.m_body,j=g.GetManifoldCount(),k=g.GetManifolds(),l=g.m_friction;g=g.m_restitution;for(var m=h.m_linearVelocity.x,n=h.m_linearVelocity.y,o=i.m_linearVelocity.x,
q=i.m_linearVelocity.y,r=h.m_angularVelocity,p=i.m_angularVelocity,s=0;s<j;++s){var v=k[s],t=v.normal.x,z=v.normal.y,u=this.m_constraints[f];u.body1=h;u.body2=i;u.manifold=v;u.normal.x=t;u.normal.y=z;u.pointCount=v.pointCount;u.friction=l;u.restitution=g;for(var C=0;C<u.pointCount;++C){var w=v.points[C],A=u.points[C];A.normalImpulse=w.normalImpulse;A.tangentImpulse=w.tangentImpulse;A.separation=w.separation;var y=w.position.x-h.m_position.x,x=w.position.y-h.m_position.y,B=w.position.x-i.m_position.x;
w=w.position.y-i.m_position.y;d=A.localAnchor1;e=h.m_R;d.x=y*e.col1.x+x*e.col1.y;d.y=y*e.col2.x+x*e.col2.y;d=A.localAnchor2;e=i.m_R;d.x=B*e.col1.x+w*e.col1.y;d.y=B*e.col2.x+w*e.col2.y;d=y*y+x*x;e=B*B+w*w;var F=y*t+x*z,E=B*t+w*z,D=h.m_invMass+i.m_invMass;D+=h.m_invI*(d-F*F)+i.m_invI*(e-E*E);A.normalMass=1/D;E=z;D=-t;F=y*E+x*D;E=B*E+w*D;D=h.m_invMass+i.m_invMass;D+=h.m_invI*(d-F*F)+i.m_invI*(e-E*E);A.tangentMass=1/D;A.velocityBias=0;if(A.separation>0)A.velocityBias=-60*A.separation;y=u.normal.x*(o+
-p*w-m- -r*x)+u.normal.y*(q+p*B-n-r*y);if(y<-b2Settings.b2_velocityThreshold)A.velocityBias+=-u.restitution*y}++f}}},PreSolve:function(){for(var a,c,b=0;b<this.m_constraintCount;++b){var d=this.m_constraints[b],e=d.body1,f=d.body2,g=e.m_invMass,h=e.m_invI,i=f.m_invMass,j=f.m_invI,k=d.normal.x,l=d.normal.y,m=l,n=-k,o=0,q=0;if(b2World.s_enableWarmStarting){q=d.pointCount;for(o=0;o<q;++o){var r=d.points[o],p=r.normalImpulse*k+r.tangentImpulse*m,s=r.normalImpulse*l+r.tangentImpulse*n;c=e.m_R;a=r.localAnchor1;
var v=c.col1.x*a.x+c.col2.x*a.y,t=c.col1.y*a.x+c.col2.y*a.y;c=f.m_R;a=r.localAnchor2;var z=c.col1.x*a.x+c.col2.x*a.y;a=c.col1.y*a.x+c.col2.y*a.y;e.m_angularVelocity-=h*(v*s-t*p);e.m_linearVelocity.x-=g*p;e.m_linearVelocity.y-=g*s;f.m_angularVelocity+=j*(z*s-a*p);f.m_linearVelocity.x+=i*p;f.m_linearVelocity.y+=i*s;r.positionImpulse=0}}else{q=d.pointCount;for(o=0;o<q;++o){e=d.points[o];e.normalImpulse=0;e.tangentImpulse=0;e.positionImpulse=0}}}},SolveVelocityConstraints:function(){for(var a=0,c,b,d,
e,f,g,h,i,j=0;j<this.m_constraintCount;++j){var k=this.m_constraints[j],l=k.body1,m=k.body2,n=l.m_angularVelocity,o=l.m_linearVelocity,q=m.m_angularVelocity,r=m.m_linearVelocity,p=l.m_invMass,s=l.m_invI,v=m.m_invMass,t=m.m_invI,z=k.normal.x,u=k.normal.y,C=u,w=-z,A=k.pointCount;for(a=0;a<A;++a){c=k.points[a];f=l.m_R;g=c.localAnchor1;b=f.col1.x*g.x+f.col2.x*g.y;d=f.col1.y*g.x+f.col2.y*g.y;f=m.m_R;g=c.localAnchor2;e=f.col1.x*g.x+f.col2.x*g.y;f=f.col1.y*g.x+f.col2.y*g.y;g=r.x+-q*f-o.x- -n*d;h=r.y+q*e-
o.y-n*b;g=-c.normalMass*(g*z+h*u-c.velocityBias);h=b2Math.b2Max(c.normalImpulse+g,0);g=h-c.normalImpulse;i=g*z;g=g*u;o.x-=p*i;o.y-=p*g;n-=s*(b*g-d*i);r.x+=v*i;r.y+=v*g;q+=t*(e*g-f*i);c.normalImpulse=h;g=r.x+-q*f-o.x- -n*d;h=r.y+q*e-o.y-n*b;g=c.tangentMass*-(g*C+h*w);h=k.friction*c.normalImpulse;h=b2Math.b2Clamp(c.tangentImpulse+g,-h,h);g=h-c.tangentImpulse;i=g*C;g=g*w;o.x-=p*i;o.y-=p*g;n-=s*(b*g-d*i);r.x+=v*i;r.y+=v*g;q+=t*(e*g-f*i);c.tangentImpulse=h}l.m_angularVelocity=n;m.m_angularVelocity=q}},
SolvePositionConstraints:function(a){for(var c=0,b,d,e=0;e<this.m_constraintCount;++e){for(var f=this.m_constraints[e],g=f.body1,h=f.body2,i=g.m_position,j=g.m_rotation,k=h.m_position,l=h.m_rotation,m=g.m_invMass,n=g.m_invI,o=h.m_invMass,q=h.m_invI,r=f.normal.x,p=f.normal.y,s=f.pointCount,v=0;v<s;++v){var t=f.points[v];b=g.m_R;d=t.localAnchor1;var z=b.col1.x*d.x+b.col2.x*d.y,u=b.col1.y*d.x+b.col2.y*d.y;b=h.m_R;d=t.localAnchor2;var C=b.col1.x*d.x+b.col2.x*d.y;b=b.col1.y*d.x+b.col2.y*d.y;d=(k.x+C-(i.x+
z))*r+(k.y+b-(i.y+u))*p+t.separation;c=b2Math.b2Min(c,d);d=a*b2Math.b2Clamp(d+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);d=-t.normalMass*d;var w=t.positionImpulse;t.positionImpulse=b2Math.b2Max(w+d,0);d=t.positionImpulse-w;t=d*r;d=d*p;i.x-=m*t;i.y-=m*d;j-=n*(z*d-u*t);g.m_R.Set(j);k.x+=o*t;k.y+=o*d;l+=q*(C*d-b*t);h.m_R.Set(l)}g.m_rotation=j;h.m_rotation=l}return c>=-b2Settings.b2_linearSlop},PostSolve:function(){for(var a=0;a<this.m_constraintCount;++a)for(var c=this.m_constraints[a],
b=c.manifold,d=0;d<c.pointCount;++d){var e=b.points[d],f=c.points[d];e.normalImpulse=f.normalImpulse;e.tangentImpulse=f.tangentImpulse}},m_allocator:null,m_constraints:[],m_constraintCount:0};var b2CircleContact=Class.create();Object.extend(b2CircleContact.prototype,b2Contact.prototype);
Object.extend(b2CircleContact.prototype,{initialize:function(a,c){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!a||!c)this.m_shape2=this.m_shape1=null;else{this.m_shape1=a;this.m_shape2=c;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_next=this.m_prev=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=
null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0}},Evaluate:function(){b2Collision.b2CollideCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,false);this.m_manifoldCount=this.m_manifold[0].pointCount>0?1:0},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});
b2CircleContact.Create=function(a,c){return new b2CircleContact(a,c)};b2CircleContact.Destroy=function(){};var b2Conservative=Class.create();b2Conservative.prototype={initialize:function(){}};b2Conservative.R1=new b2Mat22;b2Conservative.R2=new b2Mat22;b2Conservative.x1=new b2Vec2;b2Conservative.x2=new b2Vec2;
b2Conservative.Conservative=function(a,c){var b=a.GetBody(),d=c.GetBody(),e=b.m_position.x-b.m_position0.x,f=b.m_position.y-b.m_position0.y,g=b.m_rotation-b.m_rotation0,h=d.m_position.x-d.m_position0.x,i=d.m_position.y-d.m_position0.y,j=d.m_rotation-d.m_rotation0,k=a.GetMaxRadius(),l=c.GetMaxRadius(),m=b.m_position0.x,n=b.m_position0.y,o=b.m_rotation0,q=d.m_position0.x,r=d.m_position0.y,p=d.m_rotation0,s=m,v=n,t=o,z=q,u=r,C=p;b2Conservative.R1.Set(t);b2Conservative.R2.Set(C);var w=new b2Vec2(s,v);
a.QuickSync(w,b2Conservative.R1);var A=new b2Vec2(z,u);c.QuickSync(A,b2Conservative.R2);var y=0,x,B;x=0;for(var F=true,E=0;E<10;++E){var D=b2Distance.Distance(b2Conservative.x1,b2Conservative.x2,a,c);if(D<b2Settings.b2_linearSlop){F=E==0?false:true;break}if(E==0){x=b2Conservative.x2.x-b2Conservative.x1.x;B=b2Conservative.x2.y-b2Conservative.x1.y;x=x*(e-h)+B*(f-i)+Math.abs(g)*k+Math.abs(j)*l;if(Math.abs(x)<Number.MIN_VALUE){F=false;break}x=1/x}D=y+D*x;if(D<0||1<D){F=false;break}if(D<(1+100*Number.MIN_VALUE)*
y){F=true;break}y=D;s=m+y*e;v=n+y*f;t=o+y*g;z=q+y*h;u=r+y*i;C=p+y*j;b2Conservative.R1.Set(t);b2Conservative.R2.Set(C);a.QuickSync(w,b2Conservative.R1);c.QuickSync(A,b2Conservative.R2)}if(F){x=b2Conservative.x2.x-b2Conservative.x1.x;B=b2Conservative.x2.y-b2Conservative.x1.y;e=Math.sqrt(x*x+B*B);if(e>b2Settings.FLT_EPSILON){x*=b2Settings.b2_linearSlop/e;B*=b2Settings.b2_linearSlop/e}if(b.IsStatic()){b.m_position.x=s;b.m_position.y=v}else{b.m_position.x=s-x;b.m_position.y=v-B}b.m_rotation=t;b.m_R.Set(t);
b.QuickSyncShapes();if(d.IsStatic()){d.m_position.x=z;d.m_position.y=u}else{d.m_position.x=z+x;d.m_position.y=u+B}d.m_position.x=z+x;d.m_position.y=u+B;d.m_rotation=C;d.m_R.Set(C);d.QuickSyncShapes();return true}a.QuickSync(b.m_position,b.m_R);c.QuickSync(d.m_position,d.m_R);return false};var b2NullContact=Class.create();Object.extend(b2NullContact.prototype,b2Contact.prototype);
Object.extend(b2NullContact.prototype,{initialize:function(a,c){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!a||!c)this.m_shape2=this.m_shape1=null;else{this.m_shape1=a;this.m_shape2=c;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_next=this.m_prev=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=
null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null}},Evaluate:function(){},GetManifolds:function(){return null}});var b2PolyAndCircleContact=Class.create();Object.extend(b2PolyAndCircleContact.prototype,b2Contact.prototype);
Object.extend(b2PolyAndCircleContact.prototype,{initialize:function(a,c){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!a||!c)this.m_shape2=this.m_shape1=null;else{this.m_shape1=a;this.m_shape2=c;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_next=this.m_prev=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=
null;this.m_node1.other=null;this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m_manifold=[new b2Manifold];b2Settings.b2Assert(this.m_shape1.m_type==b2Shape.e_polyShape);b2Settings.b2Assert(this.m_shape2.m_type==b2Shape.e_circleShape);this.m_manifold[0].pointCount=0;this.m_manifold[0].points[0].normalImpulse=0;this.m_manifold[0].points[0].tangentImpulse=0}},Evaluate:function(){b2Collision.b2CollidePolyAndCircle(this.m_manifold[0],this.m_shape1,this.m_shape2,
false);this.m_manifoldCount=this.m_manifold[0].pointCount>0?1:0},GetManifolds:function(){return this.m_manifold},m_manifold:[new b2Manifold]});b2PolyAndCircleContact.Create=function(a,c){return new b2PolyAndCircleContact(a,c)};b2PolyAndCircleContact.Destroy=function(){};
var b2PolyContact=function(a,c){this.m_node1=new b2ContactNode;this.m_node2=new b2ContactNode;this.m_flags=0;if(!a||!c)this.m_shape2=this.m_shape1=null;else{this.m_shape1=a;this.m_shape2=c;this.m_manifoldCount=0;this.m_friction=Math.sqrt(this.m_shape1.m_friction*this.m_shape2.m_friction);this.m_restitution=b2Math.b2Max(this.m_shape1.m_restitution,this.m_shape2.m_restitution);this.m_next=this.m_prev=null;this.m_node1.contact=null;this.m_node1.prev=null;this.m_node1.next=null;this.m_node1.other=null;
this.m_node2.contact=null;this.m_node2.prev=null;this.m_node2.next=null;this.m_node2.other=null;this.m0=new b2Manifold;this.m_manifold=[new b2Manifold];this.m_manifold[0].pointCount=0}};goog.inherits(b2PolyContact,b2Contact);
b2PolyContact.prototype.Evaluate=function(){for(var a=this.m_manifold[0],c=this.m0.points,b=0;b<a.pointCount;b++){var d=c[b],e=a.points[b];d.normalImpulse=e.normalImpulse;d.tangentImpulse=e.tangentImpulse;d.id=e.id.Copy()}this.m0.pointCount=a.pointCount;b2Collision.b2CollidePoly(a,this.m_shape1,this.m_shape2,false);if(a.pointCount>0){c=[false,false];for(b=0;b<a.pointCount;++b){d=a.points[b];d.normalImpulse=0;d.tangentImpulse=0;e=d.id.key;for(var f=0;f<this.m0.pointCount;++f)if(c[f]!=true){var g=this.m0.points[f];
if(g.id.key==e){c[f]=true;d.normalImpulse=g.normalImpulse;d.tangentImpulse=g.tangentImpulse;break}}}this.m_manifoldCount=1}else this.m_manifoldCount=0};b2PolyContact.prototype.GetManifolds=function(){return this.m_manifold};b2PolyContact.Create=function(a,c){return new b2PolyContact(a,c)};b2PolyContact.Destroy=function(){};var b2ContactManager=Class.create();Object.extend(b2ContactManager.prototype,b2PairCallback.prototype);
Object.extend(b2ContactManager.prototype,{initialize:function(){this.m_nullContact=new b2NullContact;this.m_world=null;this.m_destroyImmediate=false},PairAdded:function(a,c){var b=a,d=c,e=b.m_body,f=d.m_body;if(e.IsStatic()&&f.IsStatic())return this.m_nullContact;if(b.m_body==d.m_body)return this.m_nullContact;if(f.IsConnected(e))return this.m_nullContact;if(this.m_world.m_filter!=null&&this.m_world.m_filter.ShouldCollide(b,d)==false)return this.m_nullContact;if(f.m_invMass==0){e=b;b=d;d=e}b=b2Contact.Create(b,
d,this.m_world.m_blockAllocator);if(b==null)return this.m_nullContact;else{b.m_prev=null;b.m_next=this.m_world.m_contactList;if(this.m_world.m_contactList!=null)this.m_world.m_contactList.m_prev=b;this.m_world.m_contactList=b;this.m_world.m_contactCount++}return b},PairRemoved:function(a,c,b){if(b!=null)if(b!=this.m_nullContact)if(this.m_destroyImmediate==true)this.DestroyContact(b);else b.m_flags|=b2Contact.e_destroyFlag},DestroyContact:function(a){if(a.m_prev)a.m_prev.m_next=a.m_next;if(a.m_next)a.m_next.m_prev=
a.m_prev;if(a==this.m_world.m_contactList)this.m_world.m_contactList=a.m_next;if(a.GetManifoldCount()>0){var c=a.m_shape1.m_body,b=a.m_shape2.m_body,d=a.m_node1,e=a.m_node2;c.WakeUp();b.WakeUp();if(d.prev)d.prev.next=d.next;if(d.next)d.next.prev=d.prev;if(d==c.m_contactList)c.m_contactList=d.next;d.prev=null;d.next=null;if(e.prev)e.prev.next=e.next;if(e.next)e.next.prev=e.prev;if(e==b.m_contactList)b.m_contactList=e.next;e.prev=null;e.next=null}b2Contact.Destroy(a,this.m_world.m_blockAllocator);--this.m_world.m_contactCount},
CleanContactList:function(){for(var a=this.m_world.m_contactList;a!=null;){var c=a;a=a.m_next;c.m_flags&b2Contact.e_destroyFlag&&this.DestroyContact(c)}},Collide:function(){for(var a,c,b,d,e=this.m_world.m_contactList;e!=null;e=e.m_next)if(!(e.m_shape1.m_body.IsSleeping()&&e.m_shape2.m_body.IsSleeping())){a=e.GetManifoldCount();e.Evaluate();c=e.GetManifoldCount();if(a==0&&c>0){a=e.m_shape1.m_body;c=e.m_shape2.m_body;b=e.m_node1;d=e.m_node2;b.contact=e;b.other=c;b.prev=null;b.next=a.m_contactList;
if(b.next!=null)b.next.prev=e.m_node1;a.m_contactList=e.m_node1;d.contact=e;d.other=a;d.prev=null;d.next=c.m_contactList;if(d.next!=null)d.next.prev=d;c.m_contactList=d}else if(a>0&&c==0){a=e.m_shape1.m_body;c=e.m_shape2.m_body;b=e.m_node1;d=e.m_node2;if(b.prev)b.prev.next=b.next;if(b.next)b.next.prev=b.prev;if(b==a.m_contactList)a.m_contactList=b.next;b.prev=null;b.next=null;if(d.prev)d.prev.next=d.next;if(d.next)d.next.prev=d.prev;if(d==c.m_contactList)c.m_contactList=d.next;d.prev=null;d.next=
null}}},m_world:null,m_nullContact:new b2NullContact,m_destroyImmediate:null});var b2World=Class.create();
b2World.prototype={initialize:function(a,c,b){this.step=new b2TimeStep;this.m_contactManager=new b2ContactManager;this.m_listener=null;this.m_filter=b2CollisionFilter.b2_defaultFilter;this.m_jointList=this.m_contactList=this.m_bodyList=null;this.m_jointCount=this.m_contactCount=this.m_bodyCount=0;this.m_bodyDestroyList=null;this.m_allowSleep=b;this.m_gravity=c;this.m_contactManager.m_world=this;this.m_broadPhase=new b2BroadPhase(a,this.m_contactManager);this.m_groundBody=this.CreateBody(new b2BodyDef)},
SetListener:function(a){this.m_listener=a},SetFilter:function(a){this.m_filter=a},CreateBody:function(a){a=new b2Body(a,this);a.m_prev=null;if(a.m_next=this.m_bodyList)this.m_bodyList.m_prev=a;this.m_bodyList=a;++this.m_bodyCount;return a},DestroyBody:function(a){if(!(a.m_flags&b2Body.e_destroyFlag)){if(a.m_prev)a.m_prev.m_next=a.m_next;if(a.m_next)a.m_next.m_prev=a.m_prev;if(a==this.m_bodyList)this.m_bodyList=a.m_next;a.m_flags|=b2Body.e_destroyFlag;--this.m_bodyCount;a.m_prev=null;a.m_next=this.m_bodyDestroyList;
this.m_bodyDestroyList=a}},CleanBodyList:function(){this.m_contactManager.m_destroyImmediate=true;for(var a=this.m_bodyDestroyList;a;){var c=a;a=a.m_next;for(var b=c.m_jointList;b;){var d=b;b=b.next;this.m_listener&&this.m_listener.NotifyJointDestroyed(d.joint);this.DestroyJoint(d.joint)}c.Destroy()}this.m_bodyDestroyList=null;this.m_contactManager.m_destroyImmediate=false},CreateJoint:function(a){var c=b2Joint.Create(a,this.m_blockAllocator);c.m_prev=null;if(c.m_next=this.m_jointList)this.m_jointList.m_prev=
c;this.m_jointList=c;++this.m_jointCount;c.m_node1.joint=c;c.m_node1.other=c.m_body2;c.m_node1.prev=null;if(c.m_node1.next=c.m_body1.m_jointList)c.m_body1.m_jointList.prev=c.m_node1;c.m_body1.m_jointList=c.m_node1;c.m_node2.joint=c;c.m_node2.other=c.m_body1;c.m_node2.prev=null;if(c.m_node2.next=c.m_body2.m_jointList)c.m_body2.m_jointList.prev=c.m_node2;c.m_body2.m_jointList=c.m_node2;if(a.collideConnected==false)for(a=(a.body1.m_shapeCount<a.body2.m_shapeCount?a.body1:a.body2).m_shapeList;a;a=a.m_next)a.ResetProxy(this.m_broadPhase);
return c},DestroyJoint:function(a){var c=a.m_collideConnected;if(a.m_prev)a.m_prev.m_next=a.m_next;if(a.m_next)a.m_next.m_prev=a.m_prev;if(a==this.m_jointList)this.m_jointList=a.m_next;var b=a.m_body1,d=a.m_body2;b.WakeUp();d.WakeUp();if(a.m_node1.prev)a.m_node1.prev.next=a.m_node1.next;if(a.m_node1.next)a.m_node1.next.prev=a.m_node1.prev;if(a.m_node1==b.m_jointList)b.m_jointList=a.m_node1.next;a.m_node1.prev=null;a.m_node1.next=null;if(a.m_node2.prev)a.m_node2.prev.next=a.m_node2.next;if(a.m_node2.next)a.m_node2.next.prev=
a.m_node2.prev;if(a.m_node2==d.m_jointList)d.m_jointList=a.m_node2.next;a.m_node2.prev=null;a.m_node2.next=null;b2Joint.Destroy(a,this.m_blockAllocator);--this.m_jointCount;if(c==false)for(a=(b.m_shapeCount<d.m_shapeCount?b:d).m_shapeList;a;a=a.m_next)a.ResetProxy(this.m_broadPhase)},GetGroundBody:function(){return this.m_groundBody},step:new b2TimeStep,Step:function(a,c){var b,d;this.step.dt=a;this.step.iterations=c;this.step.inv_dt=a>0?1/a:0;this.m_positionIterationCount=0;this.m_contactManager.CleanContactList();
this.CleanBodyList();this.m_contactManager.Collide();var e=new b2Island(this.m_bodyCount,this.m_contactCount,this.m_jointCount,this.m_stackAllocator);for(b=this.m_bodyList;b!=null;b=b.m_next)b.m_flags&=~b2Body.e_islandFlag;for(var f=this.m_contactList;f!=null;f=f.m_next)f.m_flags&=~b2Contact.e_islandFlag;for(f=this.m_jointList;f!=null;f=f.m_next)f.m_islandFlag=false;f=Array(this.m_bodyCount);for(var g=0;g<this.m_bodyCount;g++)f[g]=null;for(g=this.m_bodyList;g!=null;g=g.m_next)if(!(g.m_flags&(b2Body.e_staticFlag|
b2Body.e_islandFlag|b2Body.e_sleepFlag|b2Body.e_frozenFlag))){e.Clear();var h=0;f[h++]=g;for(g.m_flags|=b2Body.e_islandFlag;h>0;){b=f[--h];e.AddBody(b);b.m_flags&=~b2Body.e_sleepFlag;if(!(b.m_flags&b2Body.e_staticFlag)){for(var i=b.m_contactList;i!=null;i=i.next)if(!(i.contact.m_flags&b2Contact.e_islandFlag)){e.AddContact(i.contact);i.contact.m_flags|=b2Contact.e_islandFlag;d=i.other;if(!(d.m_flags&b2Body.e_islandFlag)){f[h++]=d;d.m_flags|=b2Body.e_islandFlag}}for(b=b.m_jointList;b!=null;b=b.next)if(b.joint.m_islandFlag!=
true){e.AddJoint(b.joint);b.joint.m_islandFlag=true;d=b.other;if(!(d.m_flags&b2Body.e_islandFlag)){f[h++]=d;d.m_flags|=b2Body.e_islandFlag}}}}e.Solve(this.step,this.m_gravity);this.m_positionIterationCount=b2Math.b2Max(this.m_positionIterationCount,b2Island.m_positionIterationCount);this.m_allowSleep&&e.UpdateSleep(a);for(d=0;d<e.m_bodyCount;++d){b=e.m_bodies[d];if(b.m_flags&b2Body.e_staticFlag)b.m_flags&=~b2Body.e_islandFlag;if(b.IsFrozen()&&this.m_listener)if(this.m_listener.NotifyBoundaryViolated(b)==
b2WorldListener.b2_destroyBody){this.DestroyBody(b);e.m_bodies[d]=null}}}this.m_broadPhase.Commit()},Query:function(a,c,b){var d=[];a=this.m_broadPhase.QueryAABB(a,d,b);for(b=0;b<a;++b)c[b]=d[b];return a},GetBodyList:function(){return this.m_bodyList},GetJointList:function(){return this.m_jointList},GetContactList:function(){return this.m_contactList},m_blockAllocator:null,m_stackAllocator:null,m_broadPhase:null,m_contactManager:new b2ContactManager,m_bodyList:null,m_contactList:null,m_jointList:null,
m_bodyCount:0,m_contactCount:0,m_jointCount:0,m_bodyDestroyList:null,m_gravity:null,m_allowSleep:null,m_groundBody:null,m_listener:null,m_filter:null,m_positionIterationCount:0};b2World.s_enablePositionCorrection=1;b2World.s_enableWarmStarting=1;var b2WorldListener=Class.create();b2WorldListener.prototype={NotifyJointDestroyed:function(){},NotifyBoundaryViolated:function(){return b2WorldListener.b2_freezeBody},initialize:function(){}};b2WorldListener.b2_freezeBody=0;
b2WorldListener.b2_destroyBody=1;var b2JointNode=Class.create();b2JointNode.prototype={other:null,joint:null,prev:null,next:null,initialize:function(){}};var b2Joint=Class.create();
b2Joint.prototype={GetType:function(){return this.m_type},GetAnchor1:function(){return null},GetAnchor2:function(){return null},GetReactionForce:function(){return null},GetReactionTorque:function(){return 0},GetBody1:function(){return this.m_body1},GetBody2:function(){return this.m_body2},GetNext:function(){return this.m_next},GetUserData:function(){return this.m_userData},initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;
this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData},PrepareVelocitySolver:function(){},SolveVelocityConstraints:function(){},PreparePositionSolver:function(){},SolvePositionConstraints:function(){return false},m_type:0,m_prev:null,m_next:null,m_node1:new b2JointNode,m_node2:new b2JointNode,m_body1:null,m_body2:null,m_islandFlag:null,m_collideConnected:null,m_userData:null};
b2Joint.Create=function(a){var c=null;switch(a.type){case b2Joint.e_distanceJoint:c=new b2DistanceJoint(a);break;case b2Joint.e_mouseJoint:c=new b2MouseJoint(a);break;case b2Joint.e_prismaticJoint:c=new b2PrismaticJoint(a);break;case b2Joint.e_revoluteJoint:c=new b2RevoluteJoint(a);break;case b2Joint.e_pulleyJoint:c=new b2PulleyJoint(a);break;case b2Joint.e_gearJoint:c=new b2GearJoint(a);break;default:break}return c};b2Joint.Destroy=function(){};b2Joint.e_unknownJoint=0;b2Joint.e_revoluteJoint=1;
b2Joint.e_prismaticJoint=2;b2Joint.e_distanceJoint=3;b2Joint.e_pulleyJoint=4;b2Joint.e_mouseJoint=5;b2Joint.e_gearJoint=6;b2Joint.e_inactiveLimit=0;b2Joint.e_atLowerLimit=1;b2Joint.e_atUpperLimit=2;b2Joint.e_equalLimits=3;var b2JointDef=Class.create();b2JointDef.prototype={initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false},type:0,userData:null,body1:null,body2:null,collideConnected:null};var b2DistanceJoint=Class.create();
Object.extend(b2DistanceJoint.prototype,b2Joint.prototype);
Object.extend(b2DistanceJoint.prototype,{initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u=new b2Vec2;var c,b,d;c=this.m_body1.m_R;b=a.anchorPoint1.x-this.m_body1.m_position.x;d=a.anchorPoint1.y-this.m_body1.m_position.y;
this.m_localAnchor1.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor1.y=b*c.col2.x+d*c.col2.y;c=this.m_body2.m_R;b=a.anchorPoint2.x-this.m_body2.m_position.x;d=a.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor2.y=b*c.col2.x+d*c.col2.y;b=a.anchorPoint2.x-a.anchorPoint1.x;d=a.anchorPoint2.y-a.anchorPoint1.y;this.m_length=Math.sqrt(b*b+d*d);this.m_impulse=0},PrepareVelocitySolver:function(){var a;a=this.m_body1.m_R;var c=a.col1.x*this.m_localAnchor1.x+
a.col2.x*this.m_localAnchor1.y,b=a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y;a=this.m_body2.m_R;var d=a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y;a=a.col1.y*this.m_localAnchor2.x+a.col2.y*this.m_localAnchor2.y;this.m_u.x=this.m_body2.m_position.x+d-this.m_body1.m_position.x-c;this.m_u.y=this.m_body2.m_position.y+a-this.m_body1.m_position.y-b;var e=Math.sqrt(this.m_u.x*this.m_u.x+this.m_u.y*this.m_u.y);e>b2Settings.b2_linearSlop?this.m_u.Multiply(1/e):this.m_u.SetZero();
e=c*this.m_u.y-b*this.m_u.x;var f=d*this.m_u.y-a*this.m_u.x;this.m_mass=this.m_body1.m_invMass+this.m_body1.m_invI*e*e+this.m_body2.m_invMass+this.m_body2.m_invI*f*f;this.m_mass=1/this.m_mass;if(b2World.s_enableWarmStarting){e=this.m_impulse*this.m_u.x;f=this.m_impulse*this.m_u.y;this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*e;this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*f;this.m_body1.m_angularVelocity-=this.m_body1.m_invI*(c*f-b*e);this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*
e;this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*f;this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(d*f-a*e)}else this.m_impulse=0},SolveVelocityConstraints:function(){var a;a=this.m_body1.m_R;var c=a.col1.x*this.m_localAnchor1.x+a.col2.x*this.m_localAnchor1.y,b=a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y;a=this.m_body2.m_R;var d=a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y;a=a.col1.y*this.m_localAnchor2.x+a.col2.y*this.m_localAnchor2.y;var e=-this.m_mass*
(this.m_u.x*(this.m_body2.m_linearVelocity.x+-this.m_body2.m_angularVelocity*a-(this.m_body1.m_linearVelocity.x+-this.m_body1.m_angularVelocity*b))+this.m_u.y*(this.m_body2.m_linearVelocity.y+this.m_body2.m_angularVelocity*d-(this.m_body1.m_linearVelocity.y+this.m_body1.m_angularVelocity*c)));this.m_impulse+=e;var f=e*this.m_u.x;e=e*this.m_u.y;this.m_body1.m_linearVelocity.x-=this.m_body1.m_invMass*f;this.m_body1.m_linearVelocity.y-=this.m_body1.m_invMass*e;this.m_body1.m_angularVelocity-=this.m_body1.m_invI*
(c*e-b*f);this.m_body2.m_linearVelocity.x+=this.m_body2.m_invMass*f;this.m_body2.m_linearVelocity.y+=this.m_body2.m_invMass*e;this.m_body2.m_angularVelocity+=this.m_body2.m_invI*(d*e-a*f)},SolvePositionConstraints:function(){var a;a=this.m_body1.m_R;var c=a.col1.x*this.m_localAnchor1.x+a.col2.x*this.m_localAnchor1.y,b=a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y;a=this.m_body2.m_R;var d=a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y;a=a.col1.y*this.m_localAnchor2.x+
a.col2.y*this.m_localAnchor2.y;var e=this.m_body2.m_position.x+d-this.m_body1.m_position.x-c,f=this.m_body2.m_position.y+a-this.m_body1.m_position.y-b,g=Math.sqrt(e*e+f*f);e/=g;f/=g;g=g-this.m_length;g=b2Math.b2Clamp(g,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);var h=-this.m_mass*g;this.m_u.Set(e,f);e=h*this.m_u.x;f=h*this.m_u.y;this.m_body1.m_position.x-=this.m_body1.m_invMass*e;this.m_body1.m_position.y-=this.m_body1.m_invMass*f;this.m_body1.m_rotation-=this.m_body1.m_invI*
(c*f-b*e);this.m_body2.m_position.x+=this.m_body2.m_invMass*e;this.m_body2.m_position.y+=this.m_body2.m_invMass*f;this.m_body2.m_rotation+=this.m_body2.m_invI*(d*f-a*e);this.m_body1.m_R.Set(this.m_body1.m_rotation);this.m_body2.m_R.Set(this.m_body2.m_rotation);return b2Math.b2Abs(g)<b2Settings.b2_linearSlop},GetAnchor1:function(){return b2Math.AddVV(this.m_body1.m_position,b2Math.b2MulMV(this.m_body1.m_R,this.m_localAnchor1))},GetAnchor2:function(){return b2Math.AddVV(this.m_body2.m_position,b2Math.b2MulMV(this.m_body2.m_R,
this.m_localAnchor2))},GetReactionForce:function(a){var c=new b2Vec2;c.SetV(this.m_u);c.Multiply(this.m_impulse*a);return c},GetReactionTorque:function(){return 0},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u:new b2Vec2,m_impulse:null,m_mass:null,m_length:null});var b2DistanceJointDef=Class.create();Object.extend(b2DistanceJointDef.prototype,b2JointDef.prototype);
Object.extend(b2DistanceJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_distanceJoint},anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2});var b2Jacobian=Class.create();
b2Jacobian.prototype={linear1:new b2Vec2,angular1:null,linear2:new b2Vec2,angular2:null,SetZero:function(){this.linear1.SetZero();this.angular1=0;this.linear2.SetZero();this.angular2=0},Set:function(a,c,b,d){this.linear1.SetV(a);this.angular1=c;this.linear2.SetV(b);this.angular2=d},Compute:function(a,c,b,d){return this.linear1.x*a.x+this.linear1.y*a.y+this.angular1*c+(this.linear2.x*b.x+this.linear2.y*b.y)+this.angular2*d},initialize:function(){this.linear1=new b2Vec2;this.linear2=new b2Vec2}};
var b2GearJoint=Class.create();Object.extend(b2GearJoint.prototype,b2Joint.prototype);
Object.extend(b2GearJoint.prototype,{GetAnchor1:function(){var a=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(a.col1.x*this.m_localAnchor1.x+a.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var a=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(a.col1.y*this.m_localAnchor2.x+a.col2.y*
this.m_localAnchor2.y))},GetReactionForce:function(){return new b2Vec2},GetReactionTorque:function(){return 0},GetRatio:function(){return this.m_ratio},initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=
new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_J=new b2Jacobian;this.m_prismatic2=this.m_revolute2=this.m_prismatic1=this.m_revolute1=null;var c,b;this.m_ground1=a.joint1.m_body1;this.m_body1=a.joint1.m_body2;if(a.joint1.m_type==b2Joint.e_revoluteJoint){this.m_revolute1=a.joint1;this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1);this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2);c=this.m_revolute1.GetJointAngle()}else{this.m_prismatic1=a.joint1;this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1);
this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2);c=this.m_prismatic1.GetJointTranslation()}this.m_ground2=a.joint2.m_body1;this.m_body2=a.joint2.m_body2;if(a.joint2.m_type==b2Joint.e_revoluteJoint){this.m_revolute2=a.joint2;this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2);b=this.m_revolute2.GetJointAngle()}else{this.m_prismatic2=a.joint2;this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1);this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2);
b=this.m_prismatic2.GetJointTranslation()}this.m_ratio=a.ratio;this.m_constant=c+this.m_ratio*b;this.m_impulse=0},PrepareVelocitySolver:function(){var a=this.m_ground1,c=this.m_ground2,b=this.m_body1,d=this.m_body2,e,f,g,h=0;this.m_J.SetZero();if(this.m_revolute1){this.m_J.angular1=-1;h+=b.m_invI}else{g=a.m_R;e=this.m_prismatic1.m_localXAxis1;a=g.col1.x*e.x+g.col2.x*e.y;e=g.col1.y*e.x+g.col2.y*e.y;g=b.m_R;f=g.col1.x*this.m_localAnchor1.x+g.col2.x*this.m_localAnchor1.y;g=g.col1.y*this.m_localAnchor1.x+
g.col2.y*this.m_localAnchor1.y;f=f*e-g*a;this.m_J.linear1.Set(-a,-e);this.m_J.angular1=-f;h+=b.m_invMass+b.m_invI*f*f}if(this.m_revolute2){this.m_J.angular2=-this.m_ratio;h+=this.m_ratio*this.m_ratio*d.m_invI}else{g=c.m_R;e=this.m_prismatic2.m_localXAxis1;a=g.col1.x*e.x+g.col2.x*e.y;e=g.col1.y*e.x+g.col2.y*e.y;g=d.m_R;f=g.col1.x*this.m_localAnchor2.x+g.col2.x*this.m_localAnchor2.y;g=g.col1.y*this.m_localAnchor2.x+g.col2.y*this.m_localAnchor2.y;f=f*e-g*a;this.m_J.linear2.Set(-this.m_ratio*a,-this.m_ratio*
e);this.m_J.angular2=-this.m_ratio*f;h+=this.m_ratio*this.m_ratio*(d.m_invMass+d.m_invI*f*f)}this.m_mass=1/h;b.m_linearVelocity.x+=b.m_invMass*this.m_impulse*this.m_J.linear1.x;b.m_linearVelocity.y+=b.m_invMass*this.m_impulse*this.m_J.linear1.y;b.m_angularVelocity+=b.m_invI*this.m_impulse*this.m_J.angular1;d.m_linearVelocity.x+=d.m_invMass*this.m_impulse*this.m_J.linear2.x;d.m_linearVelocity.y+=d.m_invMass*this.m_impulse*this.m_J.linear2.y;d.m_angularVelocity+=d.m_invI*this.m_impulse*this.m_J.angular2},
SolveVelocityConstraints:function(){var a=this.m_body1,c=this.m_body2,b=-this.m_mass*this.m_J.Compute(a.m_linearVelocity,a.m_angularVelocity,c.m_linearVelocity,c.m_angularVelocity);this.m_impulse+=b;a.m_linearVelocity.x+=a.m_invMass*b*this.m_J.linear1.x;a.m_linearVelocity.y+=a.m_invMass*b*this.m_J.linear1.y;a.m_angularVelocity+=a.m_invI*b*this.m_J.angular1;c.m_linearVelocity.x+=c.m_invMass*b*this.m_J.linear2.x;c.m_linearVelocity.y+=c.m_invMass*b*this.m_J.linear2.y;c.m_angularVelocity+=c.m_invI*b*
this.m_J.angular2},SolvePositionConstraints:function(){var a=this.m_body1,c=this.m_body2,b,d;b=this.m_revolute1?this.m_revolute1.GetJointAngle():this.m_prismatic1.GetJointTranslation();d=this.m_revolute2?this.m_revolute2.GetJointAngle():this.m_prismatic2.GetJointTranslation();b=-this.m_mass*(this.m_constant-(b+this.m_ratio*d));a.m_position.x+=a.m_invMass*b*this.m_J.linear1.x;a.m_position.y+=a.m_invMass*b*this.m_J.linear1.y;a.m_rotation+=a.m_invI*b*this.m_J.angular1;c.m_position.x+=c.m_invMass*b*this.m_J.linear2.x;
c.m_position.y+=c.m_invMass*b*this.m_J.linear2.y;c.m_rotation+=c.m_invI*b*this.m_J.angular2;a.m_R.Set(a.m_rotation);c.m_R.Set(c.m_rotation);return 0<b2Settings.b2_linearSlop},m_ground1:null,m_ground2:null,m_revolute1:null,m_prismatic1:null,m_revolute2:null,m_prismatic2:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_J:new b2Jacobian,m_constant:null,m_ratio:null,m_mass:null,m_impulse:null});var b2GearJointDef=Class.create();
Object.extend(b2GearJointDef.prototype,b2JointDef.prototype);Object.extend(b2GearJointDef.prototype,{initialize:function(){this.type=b2Joint.e_gearJoint;this.joint2=this.joint1=null;this.ratio=1},joint1:null,joint2:null,ratio:null});var b2MouseJoint=Class.create();Object.extend(b2MouseJoint.prototype,b2Joint.prototype);
Object.extend(b2MouseJoint.prototype,{GetAnchor1:function(){return this.m_target},GetAnchor2:function(){var a=b2Math.b2MulMV(this.m_body2.m_R,this.m_localAnchor);a.Add(this.m_body2.m_position);return a},GetReactionForce:function(a){var c=new b2Vec2;c.SetV(this.m_impulse);c.Multiply(a);return c},GetReactionTorque:function(){return 0},SetTarget:function(a){this.m_body2.WakeUp();this.m_target=a},initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=
this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.m_localAnchor=new b2Vec2;this.m_target=new b2Vec2;this.m_impulse=new b2Vec2;this.m_ptpMass=new b2Mat22;this.m_C=new b2Vec2;this.m_target.SetV(a.target);var c=this.m_target.x-this.m_body2.m_position.x,b=this.m_target.y-this.m_body2.m_position.y;this.m_localAnchor.x=c*this.m_body2.m_R.col1.x+
b*this.m_body2.m_R.col1.y;this.m_localAnchor.y=c*this.m_body2.m_R.col2.x+b*this.m_body2.m_R.col2.y;this.m_maxForce=a.maxForce;this.m_impulse.SetZero();b=this.m_body2.m_mass;var d=2*b2Settings.b2_pi*a.frequencyHz;c=2*b*a.dampingRatio*d;b=b*d*d;this.m_gamma=1/(c+a.timeStep*b);this.m_beta=a.timeStep*b/(c+a.timeStep*b)},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,PrepareVelocitySolver:function(){var a=this.m_body2,c;c=a.m_R;var b=c.col1.x*this.m_localAnchor.x+c.col2.x*this.m_localAnchor.y;c=c.col1.y*
this.m_localAnchor.x+c.col2.y*this.m_localAnchor.y;var d=a.m_invMass,e=a.m_invI;this.K1.col1.x=d;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=d;this.K2.col1.x=e*c*c;this.K2.col2.x=-e*b*c;this.K2.col1.y=-e*b*c;this.K2.col2.y=e*b*b;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.col1.x+=this.m_gamma;this.K.col2.y+=this.m_gamma;this.K.Invert(this.m_ptpMass);this.m_C.x=a.m_position.x+b-this.m_target.x;this.m_C.y=a.m_position.y+c-this.m_target.y;a.m_angularVelocity*=0.98;var f=this.m_impulse.x,g=
this.m_impulse.y;a.m_linearVelocity.x+=d*f;a.m_linearVelocity.y+=d*g;a.m_angularVelocity+=e*(b*g-c*f)},SolveVelocityConstraints:function(a){var c=this.m_body2,b;b=c.m_R;var d=b.col1.x*this.m_localAnchor.x+b.col2.x*this.m_localAnchor.y,e=b.col1.y*this.m_localAnchor.x+b.col2.y*this.m_localAnchor.y,f=c.m_linearVelocity.x+-c.m_angularVelocity*e,g=c.m_linearVelocity.y+c.m_angularVelocity*d;b=this.m_ptpMass;f=f+this.m_beta*a.inv_dt*this.m_C.x+this.m_gamma*this.m_impulse.x;var h=g+this.m_beta*a.inv_dt*this.m_C.y+
this.m_gamma*this.m_impulse.y;g=-(b.col1.x*f+b.col2.x*h);h=-(b.col1.y*f+b.col2.y*h);b=this.m_impulse.x;f=this.m_impulse.y;this.m_impulse.x+=g;this.m_impulse.y+=h;g=this.m_impulse.Length();g>a.dt*this.m_maxForce&&this.m_impulse.Multiply(a.dt*this.m_maxForce/g);g=this.m_impulse.x-b;h=this.m_impulse.y-f;c.m_linearVelocity.x+=c.m_invMass*g;c.m_linearVelocity.y+=c.m_invMass*h;c.m_angularVelocity+=c.m_invI*(d*h-e*g)},SolvePositionConstraints:function(){return true},m_localAnchor:new b2Vec2,m_target:new b2Vec2,
m_impulse:new b2Vec2,m_ptpMass:new b2Mat22,m_C:new b2Vec2,m_maxForce:null,m_beta:null,m_gamma:null});var b2MouseJointDef=Class.create();Object.extend(b2MouseJointDef.prototype,b2JointDef.prototype);
Object.extend(b2MouseJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false;this.target=new b2Vec2;this.type=b2Joint.e_mouseJoint;this.maxForce=0;this.frequencyHz=5;this.dampingRatio=0.7;this.timeStep=1/60},target:new b2Vec2,maxForce:null,frequencyHz:null,dampingRatio:null,timeStep:null});var b2PrismaticJoint=Class.create();Object.extend(b2PrismaticJoint.prototype,b2Joint.prototype);
Object.extend(b2PrismaticJoint.prototype,{GetAnchor1:function(){var a=this.m_body1,c=new b2Vec2;c.SetV(this.m_localAnchor1);c.MulM(a.m_R);c.Add(a.m_position);return c},GetAnchor2:function(){var a=this.m_body2,c=new b2Vec2;c.SetV(this.m_localAnchor2);c.MulM(a.m_R);c.Add(a.m_position);return c},GetJointTranslation:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;
b=c.m_R;d=c.m_position.x+(b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y)-(a.m_position.x+d);c=c.m_position.y+(b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y)-(a.m_position.y+e);b=a.m_R;return(b.col1.x*this.m_localXAxis1.x+b.col2.x*this.m_localXAxis1.y)*d+(b.col1.y*this.m_localXAxis1.x+b.col2.y*this.m_localXAxis1.y)*c},GetJointSpeed:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+
b.col2.y*this.m_localAnchor1.y;b=c.m_R;var f=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y,g=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y,h=c.m_position.x+f-(a.m_position.x+d),i=c.m_position.y+g-(a.m_position.y+e);b=a.m_R;var j=b.col1.x*this.m_localXAxis1.x+b.col2.x*this.m_localXAxis1.y;b=b.col1.y*this.m_localXAxis1.x+b.col2.y*this.m_localXAxis1.y;var k=a.m_linearVelocity,l=c.m_linearVelocity;a=a.m_angularVelocity;c=c.m_angularVelocity;return h*-a*b+i*a*j+(j*(l.x+
-c*g-k.x- -a*e)+b*(l.y+c*f-k.y-a*d))},GetMotorForce:function(a){return a*this.m_motorImpulse},SetMotorSpeed:function(a){this.m_motorSpeed=a},SetMotorForce:function(a){this.m_maxMotorForce=a},GetReactionForce:function(a){a=a*this.m_limitImpulse;var c;c=this.m_body1.m_R;return new b2Vec2(a*(c.col1.x*this.m_localXAxis1.x+c.col2.x*this.m_localXAxis1.y)+a*(c.col1.x*this.m_localYAxis1.x+c.col2.x*this.m_localYAxis1.y),a*(c.col1.y*this.m_localXAxis1.x+c.col2.y*this.m_localXAxis1.y)+a*(c.col1.y*this.m_localYAxis1.x+
c.col2.y*this.m_localYAxis1.y))},GetReactionTorque:function(a){return a*this.m_angularImpulse},initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_localXAxis1=new b2Vec2;this.m_localYAxis1=new b2Vec2;this.m_linearJacobian=
new b2Jacobian;this.m_motorJacobian=new b2Jacobian;var c,b,d;c=this.m_body1.m_R;b=a.anchorPoint.x-this.m_body1.m_position.x;d=a.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.Set(b*c.col1.x+d*c.col1.y,b*c.col2.x+d*c.col2.y);c=this.m_body2.m_R;b=a.anchorPoint.x-this.m_body2.m_position.x;d=a.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.Set(b*c.col1.x+d*c.col1.y,b*c.col2.x+d*c.col2.y);c=this.m_body1.m_R;b=a.axis.x;d=a.axis.y;this.m_localXAxis1.Set(b*c.col1.x+d*c.col1.y,b*
c.col2.x+d*c.col2.y);this.m_localYAxis1.x=-this.m_localXAxis1.y;this.m_localYAxis1.y=this.m_localXAxis1.x;this.m_initialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_linearJacobian.SetZero();this.m_angularImpulse=this.m_angularMass=this.m_linearImpulse=this.m_linearMass=0;this.m_motorJacobian.SetZero();this.m_limitPositionImpulse=this.m_limitImpulse=this.m_motorImpulse=this.m_motorMass=0;this.m_lowerTranslation=a.lowerTranslation;this.m_upperTranslation=a.upperTranslation;this.m_maxMotorForce=
a.motorForce;this.m_motorSpeed=a.motorSpeed;this.m_enableLimit=a.enableLimit;this.m_enableMotor=a.enableMotor},PrepareVelocitySolver:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;b=c.m_R;var f=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y,g=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y,h=a.m_invMass,i=c.m_invMass,j=a.m_invI,k=
c.m_invI;b=a.m_R;var l=b.col1.x*this.m_localYAxis1.x+b.col2.x*this.m_localYAxis1.y;b=b.col1.y*this.m_localYAxis1.x+b.col2.y*this.m_localYAxis1.y;var m=c.m_position.x+f-a.m_position.x,n=c.m_position.y+g-a.m_position.y;this.m_linearJacobian.linear1.x=-l;this.m_linearJacobian.linear1.y=-b;this.m_linearJacobian.linear2.x=l;this.m_linearJacobian.linear2.y=b;this.m_linearJacobian.angular1=-(m*b-n*l);this.m_linearJacobian.angular2=f*b-g*l;this.m_linearMass=h+j*this.m_linearJacobian.angular1*this.m_linearJacobian.angular1+
i+k*this.m_linearJacobian.angular2*this.m_linearJacobian.angular2;this.m_linearMass=1/this.m_linearMass;this.m_angularMass=1/(j+k);if(this.m_enableLimit||this.m_enableMotor){b=a.m_R;l=b.col1.x*this.m_localXAxis1.x+b.col2.x*this.m_localXAxis1.y;b=b.col1.y*this.m_localXAxis1.x+b.col2.y*this.m_localXAxis1.y;this.m_motorJacobian.linear1.x=-l;this.m_motorJacobian.linear1.y=-b;this.m_motorJacobian.linear2.x=l;this.m_motorJacobian.linear2.y=b;this.m_motorJacobian.angular1=-(m*b-n*l);this.m_motorJacobian.angular2=
f*b-g*l;this.m_motorMass=h+j*this.m_motorJacobian.angular1*this.m_motorJacobian.angular1+i+k*this.m_motorJacobian.angular2*this.m_motorJacobian.angular2;this.m_motorMass=1/this.m_motorMass;if(this.m_enableLimit){d=l*(m-d)+b*(n-e);if(b2Math.b2Abs(this.m_upperTranslation-this.m_lowerTranslation)<2*b2Settings.b2_linearSlop)this.m_limitState=b2Joint.e_equalLimits;else if(d<=this.m_lowerTranslation){if(this.m_limitState!=b2Joint.e_atLowerLimit)this.m_limitImpulse=0;this.m_limitState=b2Joint.e_atLowerLimit}else if(d>=
this.m_upperTranslation){if(this.m_limitState!=b2Joint.e_atUpperLimit)this.m_limitImpulse=0;this.m_limitState=b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_limitImpulse=0}}}if(this.m_enableMotor==false)this.m_motorImpulse=0;if(this.m_enableLimit==false)this.m_limitImpulse=0;if(b2World.s_enableWarmStarting){d=this.m_linearImpulse*this.m_linearJacobian.linear1.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.y;e=this.m_linearImpulse*this.m_linearJacobian.linear2.x+
(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.x;f=this.m_linearImpulse*this.m_linearJacobian.linear2.y+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear2.y;g=this.m_linearImpulse*this.m_linearJacobian.angular1-this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular1;m=this.m_linearImpulse*this.m_linearJacobian.angular2+this.m_angularImpulse+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.angular2;a.m_linearVelocity.x+=
h*(this.m_linearImpulse*this.m_linearJacobian.linear1.x+(this.m_motorImpulse+this.m_limitImpulse)*this.m_motorJacobian.linear1.x);a.m_linearVelocity.y+=h*d;a.m_angularVelocity+=j*g;c.m_linearVelocity.x+=i*e;c.m_linearVelocity.y+=i*f;c.m_angularVelocity+=k*m}else this.m_motorImpulse=this.m_limitImpulse=this.m_angularImpulse=this.m_linearImpulse=0;this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(a){var c=this.m_body1,b=this.m_body2,d=c.m_invMass,e=b.m_invMass,f=c.m_invI,g=b.m_invI,h=
-this.m_linearMass*this.m_linearJacobian.Compute(c.m_linearVelocity,c.m_angularVelocity,b.m_linearVelocity,b.m_angularVelocity);this.m_linearImpulse+=h;c.m_linearVelocity.x+=d*h*this.m_linearJacobian.linear1.x;c.m_linearVelocity.y+=d*h*this.m_linearJacobian.linear1.y;c.m_angularVelocity+=f*h*this.m_linearJacobian.angular1;b.m_linearVelocity.x+=e*h*this.m_linearJacobian.linear2.x;b.m_linearVelocity.y+=e*h*this.m_linearJacobian.linear2.y;b.m_angularVelocity+=g*h*this.m_linearJacobian.angular2;h=-this.m_angularMass*
(b.m_angularVelocity-c.m_angularVelocity);this.m_angularImpulse+=h;c.m_angularVelocity-=f*h;b.m_angularVelocity+=g*h;if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){h=-this.m_motorMass*(this.m_motorJacobian.Compute(c.m_linearVelocity,c.m_angularVelocity,b.m_linearVelocity,b.m_angularVelocity)-this.m_motorSpeed);var i=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+h,-a.dt*this.m_maxMotorForce,a.dt*this.m_maxMotorForce);h=this.m_motorImpulse-i;c.m_linearVelocity.x+=
d*h*this.m_motorJacobian.linear1.x;c.m_linearVelocity.y+=d*h*this.m_motorJacobian.linear1.y;c.m_angularVelocity+=f*h*this.m_motorJacobian.angular1;b.m_linearVelocity.x+=e*h*this.m_motorJacobian.linear2.x;b.m_linearVelocity.y+=e*h*this.m_motorJacobian.linear2.y;b.m_angularVelocity+=g*h*this.m_motorJacobian.angular2}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){h=-this.m_motorMass*this.m_motorJacobian.Compute(c.m_linearVelocity,c.m_angularVelocity,b.m_linearVelocity,b.m_angularVelocity);
if(this.m_limitState==b2Joint.e_equalLimits)this.m_limitImpulse+=h;else if(this.m_limitState==b2Joint.e_atLowerLimit){a=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+h,0);h=this.m_limitImpulse-a}else if(this.m_limitState==b2Joint.e_atUpperLimit){a=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+h,0);h=this.m_limitImpulse-a}c.m_linearVelocity.x+=d*h*this.m_motorJacobian.linear1.x;c.m_linearVelocity.y+=d*h*this.m_motorJacobian.linear1.y;c.m_angularVelocity+=
f*h*this.m_motorJacobian.angular1;b.m_linearVelocity.x+=e*h*this.m_motorJacobian.linear2.x;b.m_linearVelocity.y+=e*h*this.m_motorJacobian.linear2.y;b.m_angularVelocity+=g*h*this.m_motorJacobian.angular2}},SolvePositionConstraints:function(){var a,c,b=this.m_body1,d=this.m_body2,e=b.m_invMass,f=d.m_invMass,g=b.m_invI,h=d.m_invI,i;i=b.m_R;var j=i.col1.x*this.m_localAnchor1.x+i.col2.x*this.m_localAnchor1.y,k=i.col1.y*this.m_localAnchor1.x+i.col2.y*this.m_localAnchor1.y;i=d.m_R;a=i.col1.x*this.m_localAnchor2.x+
i.col2.x*this.m_localAnchor2.y;i=i.col1.y*this.m_localAnchor2.x+i.col2.y*this.m_localAnchor2.y;j=b.m_position.x+j;k=b.m_position.y+k;a=d.m_position.x+a;i=d.m_position.y+i;a=a-j;j=i-k;i=b.m_R;var l=(i.col1.x*this.m_localYAxis1.x+i.col2.x*this.m_localYAxis1.y)*a+(i.col1.y*this.m_localYAxis1.x+i.col2.y*this.m_localYAxis1.y)*j;l=b2Math.b2Clamp(l,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);c=-this.m_linearMass*l;b.m_position.x+=e*c*this.m_linearJacobian.linear1.x;b.m_position.y+=
e*c*this.m_linearJacobian.linear1.y;b.m_rotation+=g*c*this.m_linearJacobian.angular1;d.m_position.x+=f*c*this.m_linearJacobian.linear2.x;d.m_position.y+=f*c*this.m_linearJacobian.linear2.y;d.m_rotation+=h*c*this.m_linearJacobian.angular2;l=b2Math.b2Abs(l);c=d.m_rotation-b.m_rotation-this.m_initialAngle;c=b2Math.b2Clamp(c,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);var m=-this.m_angularMass*c;b.m_rotation-=b.m_invI*m;b.m_R.Set(b.m_rotation);d.m_rotation+=d.m_invI*m;d.m_R.Set(d.m_rotation);
m=b2Math.b2Abs(c);if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){i=b.m_R;j=i.col1.x*this.m_localAnchor1.x+i.col2.x*this.m_localAnchor1.y;k=i.col1.y*this.m_localAnchor1.x+i.col2.y*this.m_localAnchor1.y;i=d.m_R;a=i.col1.x*this.m_localAnchor2.x+i.col2.x*this.m_localAnchor2.y;i=i.col1.y*this.m_localAnchor2.x+i.col2.y*this.m_localAnchor2.y;j=b.m_position.x+j;k=b.m_position.y+k;a=d.m_position.x+a;i=d.m_position.y+i;a=a-j;j=i-k;i=b.m_R;i=(i.col1.x*this.m_localXAxis1.x+i.col2.x*this.m_localXAxis1.y)*
a+(i.col1.y*this.m_localXAxis1.x+i.col2.y*this.m_localXAxis1.y)*j;a=0;if(this.m_limitState==b2Joint.e_equalLimits){a=b2Math.b2Clamp(i,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);a=-this.m_motorMass*a;l=b2Math.b2Max(l,b2Math.b2Abs(c))}else if(this.m_limitState==b2Joint.e_atLowerLimit){a=i-this.m_lowerTranslation;l=b2Math.b2Max(l,-a);a=b2Math.b2Clamp(a+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);a=-this.m_motorMass*a;c=this.m_limitPositionImpulse;this.m_limitPositionImpulse=
b2Math.b2Max(this.m_limitPositionImpulse+a,0);a=this.m_limitPositionImpulse-c}else if(this.m_limitState==b2Joint.e_atUpperLimit){a=i-this.m_upperTranslation;l=b2Math.b2Max(l,a);a=b2Math.b2Clamp(a-b2Settings.b2_linearSlop,0,b2Settings.b2_maxLinearCorrection);a=-this.m_motorMass*a;c=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+a,0);a=this.m_limitPositionImpulse-c}b.m_position.x+=e*a*this.m_motorJacobian.linear1.x;b.m_position.y+=e*a*this.m_motorJacobian.linear1.y;
b.m_rotation+=g*a*this.m_motorJacobian.angular1;b.m_R.Set(b.m_rotation);d.m_position.x+=f*a*this.m_motorJacobian.linear2.x;d.m_position.y+=f*a*this.m_motorJacobian.linear2.y;d.m_rotation+=h*a*this.m_motorJacobian.angular2;d.m_R.Set(d.m_rotation)}return l<=b2Settings.b2_linearSlop&&m<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_localXAxis1:new b2Vec2,m_localYAxis1:new b2Vec2,m_initialAngle:null,m_linearJacobian:new b2Jacobian,m_linearMass:null,m_linearImpulse:null,
m_angularMass:null,m_angularImpulse:null,m_motorJacobian:new b2Jacobian,m_motorMass:null,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_lowerTranslation:null,m_upperTranslation:null,m_maxMotorForce:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,m_limitState:0});var b2PrismaticJointDef=Class.create();Object.extend(b2PrismaticJointDef.prototype,b2JointDef.prototype);
Object.extend(b2PrismaticJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false;this.type=b2Joint.e_prismaticJoint;this.anchorPoint=new b2Vec2(0,0);this.axis=new b2Vec2(0,0);this.motorSpeed=this.motorForce=this.upperTranslation=this.lowerTranslation=0;this.enableMotor=this.enableLimit=false},anchorPoint:null,axis:null,lowerTranslation:null,upperTranslation:null,motorForce:null,motorSpeed:null,enableLimit:null,
enableMotor:null});var b2PulleyJoint=Class.create();Object.extend(b2PulleyJoint.prototype,b2Joint.prototype);
Object.extend(b2PulleyJoint.prototype,{GetAnchor1:function(){var a=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(a.col1.x*this.m_localAnchor1.x+a.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var a=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(a.col1.y*this.m_localAnchor2.x+a.col2.y*
this.m_localAnchor2.y))},GetGroundPoint1:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor1.x,this.m_ground.m_position.y+this.m_groundAnchor1.y)},GetGroundPoint2:function(){return new b2Vec2(this.m_ground.m_position.x+this.m_groundAnchor2.x,this.m_ground.m_position.y+this.m_groundAnchor2.y)},GetReactionForce:function(){return new b2Vec2},GetReactionTorque:function(){return 0},GetLength1:function(){var a;a=this.m_body1.m_R;var c=this.m_body1.m_position.x+(a.col1.x*this.m_localAnchor1.x+
a.col2.x*this.m_localAnchor1.y)-(this.m_ground.m_position.x+this.m_groundAnchor1.x);a=this.m_body1.m_position.y+(a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y)-(this.m_ground.m_position.y+this.m_groundAnchor1.y);return Math.sqrt(c*c+a*a)},GetLength2:function(){var a;a=this.m_body2.m_R;var c=this.m_body2.m_position.x+(a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y)-(this.m_ground.m_position.x+this.m_groundAnchor2.x);a=this.m_body2.m_position.y+(a.col1.y*this.m_localAnchor2.x+
a.col2.y*this.m_localAnchor2.y)-(this.m_ground.m_position.y+this.m_groundAnchor2.y);return Math.sqrt(c*c+a*a)},GetRatio:function(){return this.m_ratio},initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.m_groundAnchor1=new b2Vec2;this.m_groundAnchor2=new b2Vec2;this.m_localAnchor1=
new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_u1=new b2Vec2;this.m_u2=new b2Vec2;var c,b,d;this.m_ground=this.m_body1.m_world.m_groundBody;this.m_groundAnchor1.x=a.groundPoint1.x-this.m_ground.m_position.x;this.m_groundAnchor1.y=a.groundPoint1.y-this.m_ground.m_position.y;this.m_groundAnchor2.x=a.groundPoint2.x-this.m_ground.m_position.x;this.m_groundAnchor2.y=a.groundPoint2.y-this.m_ground.m_position.y;c=this.m_body1.m_R;b=a.anchorPoint1.x-this.m_body1.m_position.x;d=a.anchorPoint1.y-this.m_body1.m_position.y;
this.m_localAnchor1.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor1.y=b*c.col2.x+d*c.col2.y;c=this.m_body2.m_R;b=a.anchorPoint2.x-this.m_body2.m_position.x;d=a.anchorPoint2.y-this.m_body2.m_position.y;this.m_localAnchor2.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor2.y=b*c.col2.x+d*c.col2.y;this.m_ratio=a.ratio;b=a.groundPoint1.x-a.anchorPoint1.x;d=a.groundPoint1.y-a.anchorPoint1.y;c=Math.sqrt(b*b+d*d);b=a.groundPoint2.x-a.anchorPoint2.x;d=a.groundPoint2.y-a.anchorPoint2.y;b=Math.sqrt(b*b+d*d);d=b2Math.b2Max(0.5*
b2PulleyJoint.b2_minPulleyLength,c);b=b2Math.b2Max(0.5*b2PulleyJoint.b2_minPulleyLength,b);this.m_constant=d+this.m_ratio*b;this.m_maxLength1=b2Math.b2Clamp(a.maxLength1,d,this.m_constant-this.m_ratio*b2PulleyJoint.b2_minPulleyLength);this.m_maxLength2=b2Math.b2Clamp(a.maxLength2,b,(this.m_constant-b2PulleyJoint.b2_minPulleyLength)/this.m_ratio);this.m_limitImpulse2=this.m_limitImpulse1=this.m_pulleyImpulse=0},PrepareVelocitySolver:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*
this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;b=c.m_R;var f=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y;b=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y;var g=c.m_position.x+f,h=c.m_position.y+b,i=this.m_ground.m_position.x+this.m_groundAnchor2.x,j=this.m_ground.m_position.y+this.m_groundAnchor2.y;this.m_u1.Set(a.m_position.x+d-(this.m_ground.m_position.x+this.m_groundAnchor1.x),a.m_position.y+
e-(this.m_ground.m_position.y+this.m_groundAnchor1.y));this.m_u2.Set(g-i,h-j);g=this.m_u1.Length();h=this.m_u2.Length();g>b2Settings.b2_linearSlop?this.m_u1.Multiply(1/g):this.m_u1.SetZero();h>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/h):this.m_u2.SetZero();if(g<this.m_maxLength1){this.m_limitState1=b2Joint.e_inactiveLimit;this.m_limitImpulse1=0}else{this.m_limitState1=b2Joint.e_atUpperLimit;this.m_limitPositionImpulse1=0}if(h<this.m_maxLength2){this.m_limitState2=b2Joint.e_inactiveLimit;this.m_limitImpulse2=
0}else{this.m_limitState2=b2Joint.e_atUpperLimit;this.m_limitPositionImpulse2=0}g=d*this.m_u1.y-e*this.m_u1.x;h=f*this.m_u2.y-b*this.m_u2.x;this.m_limitMass1=a.m_invMass+a.m_invI*g*g;this.m_limitMass2=c.m_invMass+c.m_invI*h*h;this.m_pulleyMass=this.m_limitMass1+this.m_ratio*this.m_ratio*this.m_limitMass2;this.m_limitMass1=1/this.m_limitMass1;this.m_limitMass2=1/this.m_limitMass2;this.m_pulleyMass=1/this.m_pulleyMass;g=(-this.m_pulleyImpulse-this.m_limitImpulse1)*this.m_u1.x;h=(-this.m_pulleyImpulse-
this.m_limitImpulse1)*this.m_u1.y;i=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.x;j=(-this.m_ratio*this.m_pulleyImpulse-this.m_limitImpulse2)*this.m_u2.y;a.m_linearVelocity.x+=a.m_invMass*g;a.m_linearVelocity.y+=a.m_invMass*h;a.m_angularVelocity+=a.m_invI*(d*h-e*g);c.m_linearVelocity.x+=c.m_invMass*i;c.m_linearVelocity.y+=c.m_invMass*j;c.m_angularVelocity+=c.m_invI*(f*j-b*i)},SolveVelocityConstraints:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*this.m_localAnchor1.x+
b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;b=c.m_R;var f=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y;b=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y;var g,h,i,j;g=a.m_linearVelocity.x+-a.m_angularVelocity*e;h=a.m_linearVelocity.y+a.m_angularVelocity*d;i=c.m_linearVelocity.x+-c.m_angularVelocity*b;j=c.m_linearVelocity.y+c.m_angularVelocity*f;g=-(this.m_u1.x*g+this.m_u1.y*h)-this.m_ratio*(this.m_u2.x*i+this.m_u2.y*
j);j=-this.m_pulleyMass*g;this.m_pulleyImpulse+=j;g=-j*this.m_u1.x;h=-j*this.m_u1.y;i=-this.m_ratio*j*this.m_u2.x;j=-this.m_ratio*j*this.m_u2.y;a.m_linearVelocity.x+=a.m_invMass*g;a.m_linearVelocity.y+=a.m_invMass*h;a.m_angularVelocity+=a.m_invI*(d*h-e*g);c.m_linearVelocity.x+=c.m_invMass*i;c.m_linearVelocity.y+=c.m_invMass*j;c.m_angularVelocity+=c.m_invI*(f*j-b*i);if(this.m_limitState1==b2Joint.e_atUpperLimit){g=a.m_linearVelocity.x+-a.m_angularVelocity*e;h=a.m_linearVelocity.y+a.m_angularVelocity*
d;g=-(this.m_u1.x*g+this.m_u1.y*h);j=-this.m_limitMass1*g;g=this.m_limitImpulse1;this.m_limitImpulse1=b2Math.b2Max(0,this.m_limitImpulse1+j);j=this.m_limitImpulse1-g;g=-j*this.m_u1.x;h=-j*this.m_u1.y;a.m_linearVelocity.x+=a.m_invMass*g;a.m_linearVelocity.y+=a.m_invMass*h;a.m_angularVelocity+=a.m_invI*(d*h-e*g)}if(this.m_limitState2==b2Joint.e_atUpperLimit){i=c.m_linearVelocity.x+-c.m_angularVelocity*b;j=c.m_linearVelocity.y+c.m_angularVelocity*f;g=-(this.m_u2.x*i+this.m_u2.y*j);j=-this.m_limitMass2*
g;g=this.m_limitImpulse2;this.m_limitImpulse2=b2Math.b2Max(0,this.m_limitImpulse2+j);j=this.m_limitImpulse2-g;i=-j*this.m_u2.x;j=-j*this.m_u2.y;c.m_linearVelocity.x+=c.m_invMass*i;c.m_linearVelocity.y+=c.m_invMass*j;c.m_angularVelocity+=c.m_invI*(f*j-b*i)}},SolvePositionConstraints:function(){var a=this.m_body1,c=this.m_body2,b,d=this.m_ground.m_position.x+this.m_groundAnchor1.x,e=this.m_ground.m_position.y+this.m_groundAnchor1.y,f=this.m_ground.m_position.x+this.m_groundAnchor2.x,g=this.m_ground.m_position.y+
this.m_groundAnchor2.y,h,i,j,k,l,m,n,o=0;b=a.m_R;h=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y;i=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;b=c.m_R;j=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y;b=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y;k=a.m_position.x+h;l=a.m_position.y+i;m=c.m_position.x+j;n=c.m_position.y+b;this.m_u1.Set(k-d,l-e);this.m_u2.Set(m-f,n-g);k=this.m_u1.Length();l=this.m_u2.Length();k>b2Settings.b2_linearSlop?
this.m_u1.Multiply(1/k):this.m_u1.SetZero();l>b2Settings.b2_linearSlop?this.m_u2.Multiply(1/l):this.m_u2.SetZero();k=this.m_constant-k-this.m_ratio*l;o=b2Math.b2Max(o,Math.abs(k));k=b2Math.b2Clamp(k,-b2Settings.b2_maxLinearCorrection,b2Settings.b2_maxLinearCorrection);n=-this.m_pulleyMass*k;k=-n*this.m_u1.x;l=-n*this.m_u1.y;m=-this.m_ratio*n*this.m_u2.x;n=-this.m_ratio*n*this.m_u2.y;a.m_position.x+=a.m_invMass*k;a.m_position.y+=a.m_invMass*l;a.m_rotation+=a.m_invI*(h*l-i*k);c.m_position.x+=c.m_invMass*
m;c.m_position.y+=c.m_invMass*n;c.m_rotation+=c.m_invI*(j*n-b*m);a.m_R.Set(a.m_rotation);c.m_R.Set(c.m_rotation);if(this.m_limitState1==b2Joint.e_atUpperLimit){b=a.m_R;h=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y;i=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;k=a.m_position.x+h;l=a.m_position.y+i;this.m_u1.Set(k-d,l-e);k=this.m_u1.Length();if(k>b2Settings.b2_linearSlop){this.m_u1.x*=1/k;this.m_u1.y*=1/k}else this.m_u1.SetZero();k=this.m_maxLength1-k;o=b2Math.b2Max(o,
-k);k=b2Math.b2Clamp(k+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);n=-this.m_limitMass1*k;d=this.m_limitPositionImpulse1;this.m_limitPositionImpulse1=b2Math.b2Max(0,this.m_limitPositionImpulse1+n);n=this.m_limitPositionImpulse1-d;k=-n*this.m_u1.x;l=-n*this.m_u1.y;a.m_position.x+=a.m_invMass*k;a.m_position.y+=a.m_invMass*l;a.m_rotation+=a.m_invI*(h*l-i*k);a.m_R.Set(a.m_rotation)}if(this.m_limitState2==b2Joint.e_atUpperLimit){b=c.m_R;j=b.col1.x*this.m_localAnchor2.x+b.col2.x*this.m_localAnchor2.y;
b=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y;m=c.m_position.x+j;n=c.m_position.y+b;this.m_u2.Set(m-f,n-g);l=this.m_u2.Length();if(l>b2Settings.b2_linearSlop){this.m_u2.x*=1/l;this.m_u2.y*=1/l}else this.m_u2.SetZero();k=this.m_maxLength2-l;o=b2Math.b2Max(o,-k);k=b2Math.b2Clamp(k+b2Settings.b2_linearSlop,-b2Settings.b2_maxLinearCorrection,0);n=-this.m_limitMass2*k;d=this.m_limitPositionImpulse2;this.m_limitPositionImpulse2=b2Math.b2Max(0,this.m_limitPositionImpulse2+n);n=this.m_limitPositionImpulse2-
d;m=-n*this.m_u2.x;n=-n*this.m_u2.y;c.m_position.x+=c.m_invMass*m;c.m_position.y+=c.m_invMass*n;c.m_rotation+=c.m_invI*(j*n-b*m);c.m_R.Set(c.m_rotation)}return o<b2Settings.b2_linearSlop},m_ground:null,m_groundAnchor1:new b2Vec2,m_groundAnchor2:new b2Vec2,m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_u1:new b2Vec2,m_u2:new b2Vec2,m_constant:null,m_ratio:null,m_maxLength1:null,m_maxLength2:null,m_pulleyMass:null,m_limitMass1:null,m_limitMass2:null,m_pulleyImpulse:null,m_limitImpulse1:null,
m_limitImpulse2:null,m_limitPositionImpulse1:null,m_limitPositionImpulse2:null,m_limitState1:0,m_limitState2:0});b2PulleyJoint.b2_minPulleyLength=b2Settings.b2_lengthUnitsPerMeter;var b2PulleyJointDef=Class.create();Object.extend(b2PulleyJointDef.prototype,b2JointDef.prototype);
Object.extend(b2PulleyJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false;this.groundPoint1=new b2Vec2;this.groundPoint2=new b2Vec2;this.anchorPoint1=new b2Vec2;this.anchorPoint2=new b2Vec2;this.type=b2Joint.e_pulleyJoint;this.groundPoint1.Set(-1,1);this.groundPoint2.Set(1,1);this.anchorPoint1.Set(-1,0);this.anchorPoint2.Set(1,0);this.maxLength1=0.5*b2PulleyJoint.b2_minPulleyLength;this.maxLength2=0.5*b2PulleyJoint.b2_minPulleyLength;
this.ratio=1;this.collideConnected=true},groundPoint1:new b2Vec2,groundPoint2:new b2Vec2,anchorPoint1:new b2Vec2,anchorPoint2:new b2Vec2,maxLength1:null,maxLength2:null,ratio:null});var b2RevoluteJoint=Class.create();Object.extend(b2RevoluteJoint.prototype,b2Joint.prototype);
Object.extend(b2RevoluteJoint.prototype,{GetAnchor1:function(){var a=this.m_body1.m_R;return new b2Vec2(this.m_body1.m_position.x+(a.col1.x*this.m_localAnchor1.x+a.col2.x*this.m_localAnchor1.y),this.m_body1.m_position.y+(a.col1.y*this.m_localAnchor1.x+a.col2.y*this.m_localAnchor1.y))},GetAnchor2:function(){var a=this.m_body2.m_R;return new b2Vec2(this.m_body2.m_position.x+(a.col1.x*this.m_localAnchor2.x+a.col2.x*this.m_localAnchor2.y),this.m_body2.m_position.y+(a.col1.y*this.m_localAnchor2.x+a.col2.y*
this.m_localAnchor2.y))},GetJointAngle:function(){return this.m_body2.m_rotation-this.m_body1.m_rotation},GetJointSpeed:function(){return this.m_body2.m_angularVelocity-this.m_body1.m_angularVelocity},GetMotorTorque:function(a){return a*this.m_motorImpulse},SetMotorSpeed:function(a){this.m_motorSpeed=a},SetMotorTorque:function(a){this.m_maxMotorTorque=a},GetReactionForce:function(a){var c=this.m_ptpImpulse.Copy();c.Multiply(a);return c},GetReactionTorque:function(a){return a*this.m_limitImpulse},
initialize:function(a){this.m_node1=new b2JointNode;this.m_node2=new b2JointNode;this.m_type=a.type;this.m_next=this.m_prev=null;this.m_body1=a.body1;this.m_body2=a.body2;this.m_collideConnected=a.collideConnected;this.m_islandFlag=false;this.m_userData=a.userData;this.K=new b2Mat22;this.K1=new b2Mat22;this.K2=new b2Mat22;this.K3=new b2Mat22;this.m_localAnchor1=new b2Vec2;this.m_localAnchor2=new b2Vec2;this.m_ptpImpulse=new b2Vec2;this.m_ptpMass=new b2Mat22;var c,b,d;c=this.m_body1.m_R;b=a.anchorPoint.x-
this.m_body1.m_position.x;d=a.anchorPoint.y-this.m_body1.m_position.y;this.m_localAnchor1.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor1.y=b*c.col2.x+d*c.col2.y;c=this.m_body2.m_R;b=a.anchorPoint.x-this.m_body2.m_position.x;d=a.anchorPoint.y-this.m_body2.m_position.y;this.m_localAnchor2.x=b*c.col1.x+d*c.col1.y;this.m_localAnchor2.y=b*c.col2.x+d*c.col2.y;this.m_intialAngle=this.m_body2.m_rotation-this.m_body1.m_rotation;this.m_ptpImpulse.Set(0,0);this.m_limitPositionImpulse=this.m_limitImpulse=this.m_motorImpulse=
0;this.m_lowerAngle=a.lowerAngle;this.m_upperAngle=a.upperAngle;this.m_maxMotorTorque=a.motorTorque;this.m_motorSpeed=a.motorSpeed;this.m_enableLimit=a.enableLimit;this.m_enableMotor=a.enableMotor},K:new b2Mat22,K1:new b2Mat22,K2:new b2Mat22,K3:new b2Mat22,PrepareVelocitySolver:function(){var a=this.m_body1,c=this.m_body2,b;b=a.m_R;var d=b.col1.x*this.m_localAnchor1.x+b.col2.x*this.m_localAnchor1.y,e=b.col1.y*this.m_localAnchor1.x+b.col2.y*this.m_localAnchor1.y;b=c.m_R;var f=b.col1.x*this.m_localAnchor2.x+
b.col2.x*this.m_localAnchor2.y;b=b.col1.y*this.m_localAnchor2.x+b.col2.y*this.m_localAnchor2.y;var g=a.m_invMass,h=c.m_invMass,i=a.m_invI,j=c.m_invI;this.K1.col1.x=g+h;this.K1.col2.x=0;this.K1.col1.y=0;this.K1.col2.y=g+h;this.K2.col1.x=i*e*e;this.K2.col2.x=-i*d*e;this.K2.col1.y=-i*d*e;this.K2.col2.y=i*d*d;this.K3.col1.x=j*b*b;this.K3.col2.x=-j*f*b;this.K3.col1.y=-j*f*b;this.K3.col2.y=j*f*f;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Invert(this.m_ptpMass);this.m_motorMass=
1/(i+j);if(this.m_enableMotor==false)this.m_motorImpulse=0;if(this.m_enableLimit){var k=c.m_rotation-a.m_rotation-this.m_intialAngle;if(b2Math.b2Abs(this.m_upperAngle-this.m_lowerAngle)<2*b2Settings.b2_angularSlop)this.m_limitState=b2Joint.e_equalLimits;else if(k<=this.m_lowerAngle){if(this.m_limitState!=b2Joint.e_atLowerLimit)this.m_limitImpulse=0;this.m_limitState=b2Joint.e_atLowerLimit}else if(k>=this.m_upperAngle){if(this.m_limitState!=b2Joint.e_atUpperLimit)this.m_limitImpulse=0;this.m_limitState=
b2Joint.e_atUpperLimit}else{this.m_limitState=b2Joint.e_inactiveLimit;this.m_limitImpulse=0}}else this.m_limitImpulse=0;if(b2World.s_enableWarmStarting){a.m_linearVelocity.x-=g*this.m_ptpImpulse.x;a.m_linearVelocity.y-=g*this.m_ptpImpulse.y;a.m_angularVelocity-=i*(d*this.m_ptpImpulse.y-e*this.m_ptpImpulse.x+this.m_motorImpulse+this.m_limitImpulse);c.m_linearVelocity.x+=h*this.m_ptpImpulse.x;c.m_linearVelocity.y+=h*this.m_ptpImpulse.y;c.m_angularVelocity+=j*(f*this.m_ptpImpulse.y-b*this.m_ptpImpulse.x+
this.m_motorImpulse+this.m_limitImpulse)}else{this.m_ptpImpulse.SetZero();this.m_limitImpulse=this.m_motorImpulse=0}this.m_limitPositionImpulse=0},SolveVelocityConstraints:function(a){var c=this.m_body1,b=this.m_body2,d;d=c.m_R;var e=d.col1.x*this.m_localAnchor1.x+d.col2.x*this.m_localAnchor1.y,f=d.col1.y*this.m_localAnchor1.x+d.col2.y*this.m_localAnchor1.y;d=b.m_R;var g=d.col1.x*this.m_localAnchor2.x+d.col2.x*this.m_localAnchor2.y;d=d.col1.y*this.m_localAnchor2.x+d.col2.y*this.m_localAnchor2.y;var h=
b.m_linearVelocity.x+-b.m_angularVelocity*d-c.m_linearVelocity.x- -c.m_angularVelocity*f,i=b.m_linearVelocity.y+b.m_angularVelocity*g-c.m_linearVelocity.y-c.m_angularVelocity*e,j=-(this.m_ptpMass.col1.x*h+this.m_ptpMass.col2.x*i);h=-(this.m_ptpMass.col1.y*h+this.m_ptpMass.col2.y*i);this.m_ptpImpulse.x+=j;this.m_ptpImpulse.y+=h;c.m_linearVelocity.x-=c.m_invMass*j;c.m_linearVelocity.y-=c.m_invMass*h;c.m_angularVelocity-=c.m_invI*(e*h-f*j);b.m_linearVelocity.x+=b.m_invMass*j;b.m_linearVelocity.y+=b.m_invMass*
h;b.m_angularVelocity+=b.m_invI*(g*h-d*j);if(this.m_enableMotor&&this.m_limitState!=b2Joint.e_equalLimits){e=-this.m_motorMass*(b.m_angularVelocity-c.m_angularVelocity-this.m_motorSpeed);f=this.m_motorImpulse;this.m_motorImpulse=b2Math.b2Clamp(this.m_motorImpulse+e,-a.dt*this.m_maxMotorTorque,a.dt*this.m_maxMotorTorque);e=this.m_motorImpulse-f;c.m_angularVelocity-=c.m_invI*e;b.m_angularVelocity+=b.m_invI*e}if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){e=-this.m_motorMass*(b.m_angularVelocity-
c.m_angularVelocity);if(this.m_limitState==b2Joint.e_equalLimits)this.m_limitImpulse+=e;else if(this.m_limitState==b2Joint.e_atLowerLimit){a=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Max(this.m_limitImpulse+e,0);e=this.m_limitImpulse-a}else if(this.m_limitState==b2Joint.e_atUpperLimit){a=this.m_limitImpulse;this.m_limitImpulse=b2Math.b2Min(this.m_limitImpulse+e,0);e=this.m_limitImpulse-a}c.m_angularVelocity-=c.m_invI*e;b.m_angularVelocity+=b.m_invI*e}},SolvePositionConstraints:function(){var a,
c=this.m_body1,b=this.m_body2,d=0;d=c.m_R;var e=d.col1.x*this.m_localAnchor1.x+d.col2.x*this.m_localAnchor1.y,f=d.col1.y*this.m_localAnchor1.x+d.col2.y*this.m_localAnchor1.y;d=b.m_R;a=d.col1.x*this.m_localAnchor2.x+d.col2.x*this.m_localAnchor2.y;var g=d.col1.y*this.m_localAnchor2.x+d.col2.y*this.m_localAnchor2.y,h=b.m_position.x+a-(c.m_position.x+e),i=b.m_position.y+g-(c.m_position.y+f);d=Math.sqrt(h*h+i*i);var j=c.m_invMass,k=b.m_invMass,l=c.m_invI,m=b.m_invI;this.K1.col1.x=j+k;this.K1.col2.x=0;
this.K1.col1.y=0;this.K1.col2.y=j+k;this.K2.col1.x=l*f*f;this.K2.col2.x=-l*e*f;this.K2.col1.y=-l*e*f;this.K2.col2.y=l*e*e;this.K3.col1.x=m*g*g;this.K3.col2.x=-m*a*g;this.K3.col1.y=-m*a*g;this.K3.col2.y=m*a*a;this.K.SetM(this.K1);this.K.AddM(this.K2);this.K.AddM(this.K3);this.K.Solve(b2RevoluteJoint.tImpulse,-h,-i);h=b2RevoluteJoint.tImpulse.x;i=b2RevoluteJoint.tImpulse.y;c.m_position.x-=c.m_invMass*h;c.m_position.y-=c.m_invMass*i;c.m_rotation-=c.m_invI*(e*i-f*h);c.m_R.Set(c.m_rotation);b.m_position.x+=
b.m_invMass*h;b.m_position.y+=b.m_invMass*i;b.m_rotation+=b.m_invI*(a*i-g*h);b.m_R.Set(b.m_rotation);e=0;if(this.m_enableLimit&&this.m_limitState!=b2Joint.e_inactiveLimit){a=b.m_rotation-c.m_rotation-this.m_intialAngle;f=0;if(this.m_limitState==b2Joint.e_equalLimits){a=b2Math.b2Clamp(a,-b2Settings.b2_maxAngularCorrection,b2Settings.b2_maxAngularCorrection);f=-this.m_motorMass*a;e=b2Math.b2Abs(a)}else if(this.m_limitState==b2Joint.e_atLowerLimit){a=a-this.m_lowerAngle;e=b2Math.b2Max(0,-a);a=b2Math.b2Clamp(a+
b2Settings.b2_angularSlop,-b2Settings.b2_maxAngularCorrection,0);f=-this.m_motorMass*a;a=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Max(this.m_limitPositionImpulse+f,0);f=this.m_limitPositionImpulse-a}else if(this.m_limitState==b2Joint.e_atUpperLimit){a=a-this.m_upperAngle;e=b2Math.b2Max(0,a);a=b2Math.b2Clamp(a-b2Settings.b2_angularSlop,0,b2Settings.b2_maxAngularCorrection);f=-this.m_motorMass*a;a=this.m_limitPositionImpulse;this.m_limitPositionImpulse=b2Math.b2Min(this.m_limitPositionImpulse+
f,0);f=this.m_limitPositionImpulse-a}c.m_rotation-=c.m_invI*f;c.m_R.Set(c.m_rotation);b.m_rotation+=b.m_invI*f;b.m_R.Set(b.m_rotation)}return d<=b2Settings.b2_linearSlop&&e<=b2Settings.b2_angularSlop},m_localAnchor1:new b2Vec2,m_localAnchor2:new b2Vec2,m_ptpImpulse:new b2Vec2,m_motorImpulse:null,m_limitImpulse:null,m_limitPositionImpulse:null,m_ptpMass:new b2Mat22,m_motorMass:null,m_intialAngle:null,m_lowerAngle:null,m_upperAngle:null,m_maxMotorTorque:null,m_motorSpeed:null,m_enableLimit:null,m_enableMotor:null,
m_limitState:0});b2RevoluteJoint.tImpulse=new b2Vec2;var b2RevoluteJointDef=Class.create();Object.extend(b2RevoluteJointDef.prototype,b2JointDef.prototype);
Object.extend(b2RevoluteJointDef.prototype,{initialize:function(){this.type=b2Joint.e_unknownJoint;this.body2=this.body1=this.userData=null;this.collideConnected=false;this.type=b2Joint.e_revoluteJoint;this.anchorPoint=new b2Vec2(0,0);this.motorSpeed=this.motorTorque=this.upperAngle=this.lowerAngle=0;this.enableMotor=this.enableLimit=false},anchorPoint:null,lowerAngle:null,upperAngle:null,motorTorque:null,motorSpeed:null,enableLimit:null,enableMotor:null});
function drawWorld(a,c){for(var b=a.m_jointList;b;b=b.m_next)drawJoint(b,c);for(b=a.m_bodyList;b;b=b.m_next)for(var d=b.GetShapeList();d!=null;d=d.GetNext())drawShape(d,c)}
function drawJoint(a,c){var b=a.m_body1,d=a.m_body2,e=b.m_position,f=d.m_position,g=a.GetAnchor1(),h=a.GetAnchor2();c.strokeStyle="#00eeee";c.beginPath();switch(a.m_type){case b2Joint.e_distanceJoint:c.moveTo(g.x,g.y);c.lineTo(h.x,h.y);break;case b2Joint.e_pulleyJoint:break;default:if(b==world.m_groundBody){c.moveTo(g.x,g.y);c.lineTo(f.x,f.y)}else if(d==world.m_groundBody){c.moveTo(g.x,g.y);c.lineTo(e.x,e.y)}else{c.moveTo(e.x,e.y);c.lineTo(g.x,g.y);c.lineTo(f.x,f.y);c.lineTo(h.x,h.y)}break}c.stroke()}
function drawShape(a,c){c.strokeStyle="#ffffff";c.beginPath();switch(a.m_type){case b2Shape.e_circleShape:var b=a.m_position,d=a.m_radius,e=0,f=2*Math.PI/16;c.moveTo(b.x+d,b.y);for(var g=0;g<16;g++){var h=new b2Vec2(d*Math.cos(e),d*Math.sin(e));h=b2Math.AddVV(b,h);c.lineTo(h.x,h.y);e+=f}c.lineTo(b.x+d,b.y);c.moveTo(b.x,b.y);g=a.m_R.col1;b=new b2Vec2(b.x+d*g.x,b.y+d*g.y);c.lineTo(b.x,b.y);break;case b2Shape.e_polyShape:b=b2Math.AddVV(a.m_position,b2Math.b2MulMV(a.m_R,a.m_vertices[0]));c.moveTo(b.x,
b.y);for(g=0;g<a.m_vertexCount;g++){h=b2Math.AddVV(a.m_position,b2Math.b2MulMV(a.m_R,a.m_vertices[g]));c.lineTo(h.x,h.y)}c.lineTo(b.x,b.y);break}c.stroke()}function createWorld(){var a=new b2AABB;a.minVertex.Set(-1000,-1000);a.maxVertex.Set(1E3,1E3);var c=new b2Vec2(0,300);a=new b2World(a,c,true);createGround(a);createBox(a,0,125,10,250);createBox(a,500,125,10,250);return a}
function createGround(a){var c=new b2BoxDef;c.extents.Set(1E3,50);c.restitution=0.2;var b=new b2BodyDef;b.AddShape(c);b.position.Set(-500,340);return a.CreateBody(b)}function createBall(a,c,b){var d=new b2CircleDef;d.density=1;d.radius=20;d.restitution=1;d.friction=0;var e=new b2BodyDef;e.AddShape(d);e.position.Set(c,b);return a.CreateBody(e)}
function createBox(a,c,b,d,e,f){if(typeof f=="undefined")f=true;var g=new b2BoxDef;if(!f)g.density=1;g.extents.Set(d,e);d=new b2BodyDef;d.AddShape(g);d.position.Set(c,b);return a.CreateBody(d)}var demos={};demos.InitWorlds=[];demos.top={};demos.top.createBall=function(a,c,b,d,e){var f=new b2CircleDef;if(!e)f.density=1;f.radius=d||10;f.restitution=0.2;d=new b2BodyDef;d.AddShape(f);d.position.Set(c,b);return a.CreateBody(d)};
demos.top.createPoly=function(a,c,b,d,e){var f=new b2PolyDef;if(!e)f.density=1;f.vertexCount=d.length;for(e=0;e<d.length;e++)f.vertices[e].Set(d[e][0],d[e][1]);d=new b2BodyDef;d.AddShape(f);d.position.Set(c,b);return a.CreateBody(d)};
demos.top.initWorld=function(a){demos.top.createBall(a,350,100,50,true);demos.top.createPoly(a,100,100,[[0,0],[10,30],[-10,30]],true);demos.top.createPoly(a,150,150,[[0,0],[10,30],[-10,30]],true);var c=createBox(a,150,100,20,20,false),b=new b2RevoluteJointDef;b.body1=c;b.body2=a.GetGroundBody();b.anchorPoint=c.GetCenterPosition();a.CreateJoint(b);c=demos.top.createPoly(a,300,200,[[0,0],[100,30],[-100,30]]);b.body1=c;b.anchorPoint=c.GetCenterPosition();a.CreateJoint(b)};demos.InitWorlds.push(demos.top.initWorld);
demos.stack={};demos.stack.initWorld=function(a){var c=new b2BoxDef,b=new b2BodyDef;b.AddShape(c);c.density=1;c.friction=0.5;c.extents.Set(10,10);for(c=0;c<8;c++){b.position.Set(250-Math.random()*2-1,245-c*22);a.CreateBody(b)}for(c=0;c<8;c++){b.position.Set(150-Math.random()*5+c,245-c*22);a.CreateBody(b)}for(c=0;c<8;c++){b.position.Set(350+Math.random()*5-c,245-c*22);a.CreateBody(b)}};demos.InitWorlds.push(demos.stack.initWorld);demos.compound={};
demos.compound.createCompoundBall=function(a,c,b){var d=new b2CircleDef;d.density=1;d.radius=20;d.restitution=0.2;d.localPosition.Set(-20,0);var e=new b2CircleDef;e.density=1;e.radius=20;e.restitution=0.2;e.localPosition.Set(20,0);var f=new b2BodyDef;f.AddShape(d);f.AddShape(e);f.position.Set(c,b);return a.CreateBody(f)};
demos.compound.createCompoundPoly=function(a,c,b){var d=[[-30,0],[30,0],[0,15]],e=new b2PolyDef;e.vertexCount=d.length;for(var f=0;f<d.length;f++)e.vertices[f].Set(d[f][0],d[f][1]);e.localRotation=0.3524*Math.PI;var g=new b2Mat22(e.localRotation);e.localPosition=b2Math.b2MulMV(g,new b2Vec2(30,0));e.density=1;g=new b2PolyDef;g.vertexCount=d.length;for(f=0;f<d.length;f++)g.vertices[f].Set(d[f][0],d[f][1]);g.localRotation=-0.3524*Math.PI;d=new b2Mat22(g.localRotation);g.localPosition=b2Math.b2MulMV(d,
new b2Vec2(-30,0));d=new b2BodyDef;d.AddShape(e);d.AddShape(g);d.position.Set(c,b);return a.CreateBody(d)};demos.compound.initWorld=function(a){var c;for(c=1;c<=4;c++)demos.compound.createCompoundPoly(a,150+3*Math.random(),40*c);for(c=1;c<=4;c++)demos.compound.createCompoundBall(a,350+3*Math.random(),45*c)};demos.InitWorlds.push(demos.compound.initWorld);demos.pendulum={};
demos.pendulum.initWorld=function(a){var c,b=a.GetGroundBody(),d=new b2RevoluteJointDef;for(c=0;c<4;c++){d.anchorPoint.Set(250+40*c,50);d.body1=b;d.body2=createBall(a,250+40*c,200);a.CreateJoint(d)}d.anchorPoint.Set(210,50);d.body1=b;d.body2=createBall(a,60,50);a.CreateJoint(d)};demos.InitWorlds.push(demos.pendulum.initWorld);demos.crank={};
demos.crank.initWorld=function(a){var c=a.m_groundBody,b=new b2BoxDef;b.extents.Set(5,25);b.density=1;var d=new b2BodyDef;d.AddShape(b);var e=new b2RevoluteJointDef,f=c;d.position.Set(250,210);var g=a.CreateBody(d);e.anchorPoint.Set(250,235);e.body1=f;e.body2=g;e.motorSpeed=-1*Math.PI;e.motorTorque=5E8;e.enableMotor=true;a.CreateJoint(e);f=g;b.extents.Set(5,45);d.position.Set(250,140);g=a.CreateBody(d);e.anchorPoint.Set(250,185);e.body1=f;e.body2=g;e.enableMotor=false;a.CreateJoint(e);f=g;b.extents.Set(20,
20);d.position.Set(250,95);g=a.CreateBody(d);e.anchorPoint.Set(250,95);e.body1=f;e.body2=g;a.CreateJoint(e);e=new b2PrismaticJointDef;e.anchorPoint.Set(250,95);e.body1=c;e.body2=g;e.axis.Set(0,1);e.motorSpeed=0;e.motorForce=1E5;e.enableMotor=true;a.CreateJoint(e);b.density=2;d.position.Set(250,10);a.CreateBody(d)};demos.InitWorlds.push(demos.crank.initWorld);var initId=0,world=createWorld(),ctx,canvasWidth,canvasHeight;
function setupWorld(a){a||(a=0);world=createWorld();initId+=a;initId%=demos.InitWorlds.length;if(initId<0)initId=demos.InitWorlds.length+initId;demos.InitWorlds[initId](world)}function setupPrevWorld(){setupWorld(-1)}function step(a){world.Step(1/60,1);ctx.clearRect(0,0,canvasWidth,canvasHeight);drawWorld(world,ctx);setTimeout("step("+(a||0)+")",10)}
Event.observe(window,"load",function(){setupWorld();ctx=$("canvas").getContext("2d");var a=$("canvas");canvasWidth=a.getLayout().get("width");canvasHeight=a.getLayout().get("height");Event.observe("canvas","click",function(c){Math.random()<0.5?demos.top.createBall(world,c.offsetX,c.offsetY):createBox(world,c.offsetX,c.offsetY,10,10,false)});Event.observe("canvas","contextmenu",function(c){c.preventDefault&&c.preventDefault();setupPrevWorld();return false});step()});
